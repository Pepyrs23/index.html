<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1220" />
  <title>CashControl</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --muted:#93a4c7; --text:#e7efff;
      --accent:#60a5fa; --good:#34d399; --bad:#fb7185; --warn:#fbbf24;
      --border:#223056; --input:#0f1b37;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#0b1220,#070c16);
      color:var(--text);
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 0 10px;gap:10px}
    h1{font-size:18px;margin:0;white-space:nowrap}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--border);border-radius:999px;white-space:nowrap}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{
      background:rgba(16,26,51,.88); border:1px solid var(--border);
      border-radius:16px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .value{font-size:18px;font-weight:900}
    .value.good{color:var(--good)}
    .value.bad{color:var(--bad)}
    .value.warn{color:var(--warn)}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    input, select, button, textarea{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      font-size:14px;
    }
    textarea{min-height:72px;resize:vertical}
    button{
      background:linear-gradient(180deg,#60a5fa,#3b82f6);
      border:none; font-weight:900;
      cursor:pointer;
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    button.secondary{
      background:transparent; border:1px solid var(--border); color:var(--text);
      font-weight:800;
    }
    button.danger{
      background:transparent; border:1px solid rgba(251,113,133,.55); color:var(--text);
      font-weight:900;
    }
    .tabs{display:flex;gap:8px;margin:10px 0 12px;flex-wrap:wrap}
    .tab{
      flex:1; min-width:120px;
      padding:10px 10px; border-radius:999px;
      border:1px solid var(--border); background:transparent; color:var(--muted);
      font-weight:900;
    }
    .tab.active{background:rgba(96,165,250,.15); color:var(--text); border-color:rgba(96,165,250,.4)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(12,22,49,.55)
    }
    .item .meta{min-width:0}
    .item .meta .t{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta .s{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35;white-space:pre-line}
    .amt{font-weight:1000;white-space:nowrap}
    .amt.in{color:var(--good)}
    .amt.out{color:var(--bad)}
    .amt.good{color:var(--good)}
    .amt.bad{color:var(--bad)}
    .amt.warn{color:var(--warn)}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .right{text-align:right}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(12,22,49,.55); color:var(--muted); font-size:12px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .banner{
      border:1px solid rgba(251,191,36,.45);
      background:rgba(251,191,36,.08);
      padding:10px 12px;border-radius:14px;color:var(--text);
    }
    .banner.bad{
      border-color:rgba(251,113,133,.55);
      background:rgba(251,113,133,.08);
    }

    /* Chart.js stable size */
    .chartBox{ height:240px; position:relative; }
    .chartBox canvas{ width:100% !important; height:100% !important; display:block; }

    /* Login overlay */
    .overlay{
      position:fixed; inset:0;
      background:linear-gradient(180deg,rgba(11,18,32,.96),rgba(7,12,22,.96));
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      display:none;
      overflow:auto;
      z-index:9999;
    }
    .overlay header{padding-top:18px}
  </style>
</head>
<body>

  <!-- LOGIN / PROFILE OVERLAY -->
  <div class="overlay" id="profileOverlay">
    <header>
      <h1>üë§ –ü—Ä–æ—Ñ–∏–ª–∏</h1>
      <div class="pill" id="overlayPill">CashControl</div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="label">–ò–∑–±–µ—Ä–∏ –ø—Ä–æ—Ñ–∏–ª</div>
        <div class="list" id="profileList"></div>
        <div class="hr"></div>
        <button class="secondary" id="btnShowCreate" type="button">+ –ù–æ–≤ –ø—Ä–æ—Ñ–∏–ª</button>
        <div class="small" style="margin-top:10px">
          –ü—Ä–æ—Ñ–∏–ª–∏—Ç–µ —Å–∞ <b>–ª–æ–∫–∞–ª–Ω–∏</b> (–Ω–∞ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä). –ó–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª—è–Ω–µ –ø–æ–ª–∑–≤–∞–π Export/Import.
        </div>
      </div>

      <div class="card" id="createBox" style="display:none">
        <div class="label">–°—ä–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª</div>
        <input id="newName" placeholder="–ò–º–µ (–Ω–∞–ø—Ä. –ò–≤–∞–Ω)" />
        <input id="newPin" type="password" inputmode="numeric" placeholder="PIN (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)" style="margin-top:10px" />
        <div class="two" style="margin-top:10px">
          <button id="btnCreate" type="button">–°—ä–∑–¥–∞–π</button>
          <button class="secondary" id="btnCancelCreate" type="button">–û—Ç–∫–∞–∑</button>
        </div>
        <div class="small" style="margin-top:10px">
          –ê–∫–æ –æ—Å—Ç–∞–≤–∏—à PIN –ø—Ä–∞–∑–µ–Ω ‚Üí –ø—Ä–æ—Ñ–∏–ª—ä—Ç —â–µ –≤–ª–∏–∑–∞ –±–µ–∑ PIN.
        </div>
      </div>

      <div class="card" id="loginBox" style="display:none">
        <div class="label">–í—Ö–æ–¥</div>
        <div class="small" id="loginHint">‚Äî</div>
        <input id="loginPin" type="password" inputmode="numeric" placeholder="PIN" style="margin-top:10px" />
        <div class="two" style="margin-top:10px">
          <button id="btnLogin" type="button">–í–ª–µ–∑</button>
          <button class="secondary" id="btnCancelLogin" type="button">–ù–∞–∑–∞–¥</button>
        </div>
        <div class="small" id="loginLockHint" style="margin-top:10px;display:none"></div>
      </div>

      <div class="card">
        <div class="label">–ò–º–ø–æ—Ä—Ç (–Ω–∞ –ø—Ä–æ—Ñ–∏–ª)</div>
        <div class="small">–ò–∑–±–µ—Ä–∏ JSON —Ñ–∞–π–ª, –∫–æ–π—Ç–æ —Å–∏ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–ª –æ—Ç CashControl.</div>
        <div class="hr"></div>
        <button class="secondary" id="btnOverlayImport" type="button">–ò–º–ø–æ—Ä—Ç JSON</button>
        <input id="overlayImportFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <header>
    <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
      <h1>üìä CashControl</h1>
      <div class="small" id="profileNameLine">–ü—Ä–æ—Ñ–∏–ª: ‚Äî</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="pill" id="monthPill">‚Äî</div>
      <button class="secondary" id="btnProfiles" type="button" aria-label="–ü—Ä–æ—Ñ–∏–ª–∏" style="width:auto;padding:8px 10px;border-radius:999px">üë§</button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tabDash" type="button">–¢–∞–±–ª–æ</button>
    <button class="tab" id="tabAdd" type="button">–î–æ–±–∞–≤–∏</button>
    <button class="tab" id="tabRecurring" type="button">Recurring</button>
    <button class="tab" id="tabCredits" type="button">–ö—Ä–µ–¥–∏—Ç–∏</button>
    <button class="tab" id="tabCar" type="button">–ö–æ–ª–∞</button>
    <button class="tab" id="tabPlan" type="button">–ü–ª–∞–Ω</button>
    <button class="tab" id="tabReports" type="button">–û—Ç—á–µ—Ç–∏</button>
    <button class="tab" id="tabSettings" type="button">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <!-- DASH -->
  <section id="viewDash" class="grid">
    <div class="card">
      <div class="label">–ú–µ—Å–µ—Ü</div>
      <select id="selMonth"></select>
      <div class="small" style="margin-top:6px">
        –°—É–º–∏—Ç–µ –≤–∫–ª—é—á–≤–∞—Ç: <b>—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</b> + <b>recurring</b> + <b>–∫—Ä–µ–¥–∏—Ç–∏</b>.
      </div>
    </div>

    <div id="alertBox" class="banner" style="display:none"></div>

    <div class="grid cards">
      <div class="card">
        <div class="label">–î–æ—Ö–æ–¥–∏</div>
        <div class="value" id="kIncome">‚Ç¨0</div>
        <div class="small" id="kIncomeNote">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–†–∞–∑—Ö–æ–¥–∏</div>
        <div class="value" id="kExpense">‚Ç¨0</div>
        <div class="small" id="kExpenseNote">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è</div>
        <div class="value" id="kSavings">‚Ç¨0</div>
        <div class="small">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ + recurring —Ç–∏–ø ‚Äû–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ‚Äú</div>
      </div>
      <div class="card">
        <div class="label">–ù–µ—Ç–Ω–æ</div>
        <div class="value" id="kNet">‚Ç¨0</div>
        <div class="small" id="kNetNote">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="label">–¶–µ–ª —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è</div>
          <div class="value" id="kGoal">‚Ç¨0</div>
        </div>
        <div class="right">
          <div class="label">–ù–∞—Ç—Ä—É–ø–∞–Ω–æ</div>
          <div class="value" id="kGoalNow">‚Ç¨0</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small" id="goalProgressTxt">‚Äî</div>
      <div style="height:10px;background:#0b1430;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:8px">
        <div id="goalBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--good),var(--accent))"></div>
      </div>
    </div>

    <div class="card">
      <div class="label">–°–ø—Ä—è–º–æ –º–∏–Ω–∞–ª–∏—è –º–µ—Å–µ—Ü</div>
      <div class="list" id="momList"></div>
      <div class="small" style="margin-top:8px">–ü—Ä–æ–º—è–Ω–∞ —Å–ø—Ä—è–º–æ –ø—Ä–µ–¥—Ö–æ–¥–Ω–∏—è –º–µ—Å–µ—Ü.</div>
    </div>

    <div class="card">
      <div class="label">–ö—ä–¥–µ ‚Äú–∏–∑—Ç–∏—á–∞—Ç‚Äù –ø–∞—Ä–∏—Ç–µ (Top 3)</div>
      <div class="list" id="leaksList"></div>
      <div class="small" style="margin-top:8px">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –Ω–∞–π-–≥–æ–ª—è–º —Ä—ä—Å—Ç —Å–ø—Ä—è–º–æ –º–∏–Ω–∞–ª–∏—è –º–µ—Å–µ—Ü.</div>
    </div>

    <div class="card">
      <div class="label">–ë—é–¥–∂–µ—Ç–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü)</div>
      <div class="list" id="budgetProgress"></div>
      <div class="small" style="margin-top:8px">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –±—é–¥–∂–µ—Ç.</div>
    </div>

    <div class="card">
      <div class="label">–†–∞–∑—Ö–æ–¥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü)</div>
      <div class="chartBox"><canvas id="chartCats"></canvas></div>
      <div class="small" style="margin-top:8px">–í–∫–ª—é—á–≤–∞ recurring –∏ –∫—Ä–µ–¥–∏—Ç–∏.</div>
    </div>

    <div class="card">
      <div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü)</div>
      <div class="list" id="txList"></div>
    </div>

    <div class="card">
      <div class="label">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (Recurring + –ö—Ä–µ–¥–∏—Ç–∏)</div>
      <div class="list" id="autoListDash"></div>
      <div class="small" id="autoHintDash" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ADD -->
  <section id="viewAdd" class="grid" style="display:none">
    <div class="card">
      <div class="label">–î–æ–±–∞–≤–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (–º–µ—Å–µ—Ü—ä—Ç —Å–µ –≤–∑–∏–º–∞ –æ—Ç –¥–∞—Ç–∞—Ç–∞)</div>

      <div class="two">
        <input id="txDate" type="date" />
        <select id="txType">
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="expense">–†–∞–∑—Ö–æ–¥</option>
          <option value="saving">–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ</option>
        </select>
      </div>

      <div class="two" style="margin-top:10px">
        <select id="txCat"></select>
        <select id="txSubcat"></select>
      </div>

      <div style="margin-top:10px">
        <input id="txAmt" type="number" inputmode="decimal" placeholder="–°—É–º–∞ (EUR)" />
      </div>

      <textarea id="txNote" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)" style="margin-top:10px"></textarea>

      <div class="two" style="margin-top:10px">
        <button id="btnAddTx" type="button">–î–æ–±–∞–≤–∏</button>
        <button class="secondary" id="btnClearTx" type="button">–ò–∑—á–∏—Å—Ç–∏</button>
      </div>
    </div>

    <div class="card">
      <div class="label">–ë—ä—Ä–∑–∏ –±—É—Ç–æ–Ω–∏</div>
      <div class="three">
        <button class="secondary" id="quickSalary" type="button">+ –ó–∞–ø–ª–∞—Ç–∞</button>
        <button class="secondary" id="quickVouchers" type="button">+ –í–∞—É—á–µ—Ä–∏</button>
        <button class="secondary" id="quickFuel" type="button">‚àí –ì–æ—Ä–∏–≤–æ</button>
      </div>
      <div class="small" style="margin-top:8px">–ü–æ–ø—ä–ª–≤–∞ —Ç–∏–ø/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –¢–∏ –≤—ä–≤–µ–∂–¥–∞—à –¥–∞—Ç–∞ –∏ —Å—É–º–∞.</div>
    </div>

    <div class="card">
      <div class="label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü) ‚Äì –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ</div>
      <div class="list" id="txListManage"></div>
    </div>
  </section>

  <!-- RECURRING -->
  <section id="viewRecurring" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ü–æ–≤—Ç–∞—Ä—è—â–∏ —Å–µ –∑–∞–ø–∏—Å–∏ (Recurring)</div>
      <div class="small">–î–æ–±–∞–≤—è–π —Ä–∞–∑—Ö–æ–¥–∏/–¥–æ—Ö–æ–¥–∏/—Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è, –∫–æ–∏—Ç–æ —Å–µ –ø–æ–≤—Ç–∞—Ä—è—Ç. –í–ª–∏–∑–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ä–≤ –≤—Å–∏—á–∫–∏ –æ—Ç—á–µ—Ç–∏.</div>
      <div class="hr"></div>

      <input id="recName" placeholder="–ò–º–µ (–Ω–∞–ø—Ä. Netflix / –ù–∞–µ–º / –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞)" />

      <div class="two" style="margin-top:10px">
        <select id="recType">
          <option value="expense">–†–∞–∑—Ö–æ–¥</option>
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="saving">–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ</option>
        </select>
        <input id="recAmt" type="number" inputmode="decimal" placeholder="–°—É–º–∞ (EUR)" />
      </div>

      <div class="two" style="margin-top:10px">
        <select id="recCat"></select>
        <select id="recSubcat"></select>
      </div>

      <div class="two" style="margin-top:10px">
        <select id="recEvery">
          <option value="monthly">–í—Å–µ–∫–∏ –º–µ—Å–µ—Ü</option>
          <option value="q3">–ù–∞ 3 –º–µ—Å–µ—Ü–∞</option>
          <option value="q6">–ù–∞ 6 –º–µ—Å–µ—Ü–∞</option>
          <option value="yearly">–í–µ–¥–Ω—ä–∂ –≥–æ–¥–∏—à–Ω–æ</option>
        </select>
        <input id="recAnchor" type="month" />
      </div>

      <div class="two" style="margin-top:10px">
        <input id="recEnd" type="month" placeholder="–ö—Ä–∞–π (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)" />
        <button id="btnAddRec" type="button">+ –î–æ–±–∞–≤–∏</button>
      </div>

      <div class="hr"></div>
      <div class="list" id="recList"></div>
    </div>
  </section>

  <!-- CREDITS -->
  <section id="viewCredits" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ö—Ä–µ–¥–∏—Ç–∏ ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ</div>
      <div class="small">–ö—Ä–µ–¥–∏—Ç–∏—Ç–µ —Å–µ –¥–æ–±–∞–≤—è—Ç –æ—Ç–¥–µ–ª–Ω–æ. (Recurring –µ –∑–∞ –≤—Å–∏—á–∫–æ –æ—Å—Ç–∞–Ω–∞–ª–æ.)</div>
      <div class="hr"></div>

      <input id="crName" placeholder="–ò–º–µ (–Ω–∞–ø—Ä. –ö—Ä–µ–¥–∏—Ç)" />
      <div class="two" style="margin-top:10px">
        <input id="crPay" type="number" inputmode="decimal" placeholder="–ú–µ—Å–µ—á–Ω–∞ –≤–Ω–æ—Å–∫–∞ (‚Ç¨)" />
        <select id="crMode">
          <option value="expense">–†–∞–∑—Ö–æ–¥</option>
          <option value="saving">–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ</option>
        </select>
      </div>

      <div class="two" style="margin-top:10px">
        <input id="crStart" type="month" />
        <input id="crEnd" type="month" />
      </div>

      <textarea id="crNote" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)" style="margin-top:10px"></textarea>

      <div class="two" style="margin-top:10px">
        <button id="btnSaveCredit" type="button">–ó–∞–ø–∞–∑–∏ –∫—Ä–µ–¥–∏—Ç</button>
        <button class="secondary" id="btnNewCredit" type="button">–ù–æ–≤</button>
      </div>
    </div>

    <div class="card">
      <div class="label">–°–ø–∏—Å—ä–∫ –∫—Ä–µ–¥–∏—Ç–∏</div>
      <div class="list" id="creditList"></div>
    </div>
  </section>

  <!-- CAR -->
  <section id="viewCar" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ì—Ä–∞—Ñ–∏–∫–∞: —Ä–∞–∑—Ö–æ–¥–∏ –∑–∞ –∫–æ–ª–∞ (12 –º–µ—Å–µ—Ü–∞)</div>
      <div class="chartBox"><canvas id="chartCar"></canvas></div>
      <div class="small" style="margin-top:8px">–í–∫–ª—é—á–≤–∞ —Ä–∞–∑—Ö–æ–¥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äû–ö–æ–ª–∞‚Äú (–≥–æ—Ä–∏–≤–æ, —Ä–µ–º–æ–Ω—Ç–∏, –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∞, –∫–∞—Å–∫–æ, –¥–∞–Ω—ä–∫, –≤–∏–Ω–µ—Ç–∫–∞ –∏ –¥—Ä.).</div>
    </div>

    <div class="card">
      <div class="label">–¢–æ–∑–∏ –º–µ—Å–µ—Ü ‚Äì –∫–æ–ª–∞ (–ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)</div>
      <div class="list" id="carThisMonth"></div>
      <div class="small" id="carHint" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- PLAN -->
  <section id="viewPlan" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ü–ª–∞–Ω –¥–æ—Ö–æ–¥ + –ü—Ä–æ–≥–Ω–æ–∑–∞ (12 –º–µ—Å–µ—Ü–∞)</div>
      <div class="small">–ü—Ä–æ–≥–Ω–æ–∑–∞—Ç–∞ –∏–∑–ø–æ–ª–∑–≤–∞: –ü–ª–∞–Ω –¥–æ—Ö–æ–¥ + recurring + –∫—Ä–µ–¥–∏—Ç–∏ + –∂–µ–ª–∞–Ω–æ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–µ.</div>
      <div class="hr"></div>
      <div class="two">
        <div>
          <div class="label">–ü–ª–∞–Ω –∑–∞–ø–ª–∞—Ç–∞ (‚Ç¨)</div>
          <input id="planSalary" type="number" inputmode="decimal" />
        </div>
        <div>
          <div class="label">–ü–ª–∞–Ω –≤–∞—É—á–µ—Ä–∏ (‚Ç¨)</div>
          <input id="planVouchers" type="number" inputmode="decimal" />
        </div>
      </div>
      <button style="margin-top:12px" id="btnSavePlan" type="button">–ó–∞–ø–∞–∑–∏ –ø–ª–∞–Ω</button>
    </div>

    <div class="card">
      <div class="label">–¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</div>
      <div class="list" id="forecastList"></div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="viewReports" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ù–∞—Ç—Ä—É–ø–∞–Ω–∏ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è (24 –º–µ—Å–µ—Ü–∞)</div>
      <div class="chartBox"><canvas id="chartCum"></canvas></div>
    </div>

    <div class="card">
      <div class="label">–ù–µ—Ç–Ω–æ –ø–æ –º–µ—Å–µ—Ü–∏ (12 –º–µ—Å–µ—Ü–∞)</div>
      <div class="chartBox"><canvas id="chartNet"></canvas></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="viewSettings" class="grid" style="display:none">
    <div class="card">
      <div class="label">–¶–µ–ª –∏ –Ω–∞—á–∞–ª–Ω–∏ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è</div>
      <div class="two">
        <input id="setGoal" type="number" inputmode="decimal" placeholder="–¶–µ–ª (‚Ç¨)" />
        <input id="setStart" type="number" inputmode="decimal" placeholder="–ù–∞—á–∞–ª–Ω–∏ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è (‚Ç¨)" />
      </div>
      <div style="margin-top:10px">
        <input id="setSaveTarget" type="number" inputmode="decimal" placeholder="–ñ–µ–ª–∞–Ω–æ –º–µ—Å–µ—á–Ω–æ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–µ (‚Ç¨) –∑–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞" />
      </div>
      <button style="margin-top:10px" id="btnSaveSettings" type="button">–ó–∞–ø–∞–∑–∏</button>
    </div>

    <div class="card">
      <div class="label">–ë—é–¥–∂–µ—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
      <div class="small">–ó–∞–¥–∞–π –º–µ—Å–µ—á–µ–Ω –±—é–¥–∂–µ—Ç –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è. –ù–∞ —Ç–∞–±–ª–æ—Ç–æ —â–µ –ø–æ–ª—É—á–∏—à –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–¥–≤–∏—à–∞–≤–∞–Ω–µ.</div>
      <div class="hr"></div>

      <div class="two">
        <select id="budCat"></select>
        <input id="budAmt" type="number" inputmode="decimal" placeholder="–ë—é–¥–∂–µ—Ç (EUR)" />
      </div>

      <div class="two" style="margin-top:10px">
        <button id="btnSaveBudget" type="button">–ó–∞–ø–∞–∑–∏</button>
        <button class="secondary" id="btnDeleteBudget" type="button">–ò–∑—Ç—Ä–∏–π</button>
      </div>

      <div class="hr"></div>
      <div class="list" id="budList"></div>
    </div>

    <div class="card">
      <div class="label">–ü—Ä–æ—Ñ–∏–ª</div>
      <div class="small">–¢–æ–≤–∞ –µ –ª–æ–∫–∞–ª–µ–Ω –ø—Ä–æ—Ñ–∏–ª —Å–∞–º–æ –∑–∞ —Ç–æ–∑–∏ –±—Ä–∞—É–∑—ä—Ä.</div>
      <div class="hr"></div>
      <div class="two">
        <button class="secondary" id="btnSwitchProfile" type="button">–°–º–µ–Ω–∏ –ø—Ä–æ—Ñ–∏–ª</button>
        <button class="secondary" id="btnLogout" type="button">–ò–∑—Ö–æ–¥</button>
      </div>
      <div class="hr"></div>
      <div class="two">
        <button class="secondary" id="btnExportProfile" type="button">Export (–ø—Ä–æ—Ñ–∏–ª)</button>
        <button class="secondary" id="btnImportProfile" type="button">Import (–ø—Ä–æ—Ñ–∏–ª)</button>
      </div>
      <input id="importProfileFile" type="file" accept="application/json" style="display:none" />
      <div class="small" style="margin-top:10px">
        Export/Import –µ –Ω–∞–π-–¥–æ–±—Ä–∏—è—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–∏ —Å–º—è–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.
      </div>
    </div>

    <div class="card">
      <div class="label">–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ</div>
      <div class="small">–ò–∑—Ç—Ä–∏–≤–∞ —Å–∞–º–æ –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è –ø—Ä–æ—Ñ–∏–ª.</div>
      <div class="hr"></div>
      <button class="danger" id="btnReset" type="button">–ò–∑—Ç—Ä–∏–π –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞</button>
      <div class="small" style="margin-top:10px">
        –ê–∫–æ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à –∏ —Å–∞–º–∏—è –ø—Ä–æ—Ñ–∏–ª ‚Üí –æ—Ç ‚Äû–ü—Ä–æ—Ñ–∏–ª–∏‚Äú (üë§) –∏ ‚Äû–ò–∑—Ç—Ä–∏–π‚Äú.
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ==========================================================
    // CashControl (Professional Clean)
    // - Category + Subcategory
    // - Recurring (single engine) replaces hardcoded Auto fields
    // - Budgets by category + budget progress
    // - MoM comparison + Top leaks
    // - Safer rendering (no innerHTML with user strings)
    // ==========================================================

    // =========================
    // PROFILE SYSTEM (LOCAL)
    // =========================
    const PROFILES_KEY = "cashcontrol_profiles_v3";
    const ACTIVE_PROFILE_KEY = "cashcontrol_active_profile_v3";
    const STATE_VERSION = 3;

    const monthNamesBG = ["–Ø–Ω—É–∞—Ä–∏","–§–µ–≤—Ä—É–∞—Ä–∏","–ú–∞—Ä—Ç","–ê–ø—Ä–∏–ª","–ú–∞–π","–Æ–Ω–∏","–Æ–ª–∏","–ê–≤–≥—É—Å—Ç","–°–µ–ø—Ç–µ–º–≤—Ä–∏","–û–∫—Ç–æ–º–≤—Ä–∏","–ù–æ–µ–º–≤—Ä–∏","–î–µ–∫–µ–º–≤—Ä–∏"];
    const fmt = new Intl.NumberFormat('bg-BG', { style:'currency', currency:'EUR' });

    const byId = (id)=>document.getElementById(id);
    const pad2 = (n)=>String(n).padStart(2,"0");
    const ymNow = ()=>{ const d=new Date(); return d.getFullYear()+"-"+pad2(d.getMonth()+1); };
    const ymFromDate = (dateStr)=> dateStr ? dateStr.slice(0,7) : "";
    const ymToLabel = (ymStr)=>{ const [y,m]=ymStr.split("-").map(Number); return monthNamesBG[m-1]+" "+y; };
    const addMonths = (ymStr, delta)=>{
      const [y,m]=ymStr.split("-").map(Number);
      const d=new Date(y, m-1, 1);
      d.setMonth(d.getMonth()+delta);
      return d.getFullYear()+"-"+pad2(d.getMonth()+1);
    };

    function uuid(){
      if (window.crypto?.randomUUID) return crypto.randomUUID();
      return "id_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
    }
    function el(tag, className, text){
      const e = document.createElement(tag);
      if(className) e.className = className;
      if(text !== undefined) e.textContent = String(text);
      return e;
    }
    function toMoney(n){
      n = Number(n);
      if(!Number.isFinite(n)) return 0;
      return Math.round(n * 100) / 100;
    }
    function clampText(s, max=200){
      s = (s ?? "").toString();
      return s.length > max ? s.slice(0,max) : s;
    }

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    function randomSalt(){
      const a = new Uint8Array(16);
      crypto.getRandomValues(a);
      return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    async function hashPin(pin, salt){
      return sha256(`${salt}:${pin}`);
    }

    function loadProfiles(){
      try{
        const raw = localStorage.getItem(PROFILES_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveProfiles(list){
      localStorage.setItem(PROFILES_KEY, JSON.stringify(list));
    }
    function getActiveProfileId(){
      return localStorage.getItem(ACTIVE_PROFILE_KEY) || "";
    }
    function setActiveProfileId(id){
      localStorage.setItem(ACTIVE_PROFILE_KEY, id);
    }
    function profileStoreKey(id){ return "cashcontrol_profile_state_v3__" + id; }

    function loadStateForProfile(profileId){
      const key = profileStoreKey(profileId);
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }
    function saveStateForProfile(profileId, stateObj){
      const key = profileStoreKey(profileId);
      localStorage.setItem(key, JSON.stringify(stateObj));
    }

    // Debounced persist
    let persistTimer = null;
    function persistSoon(){
      if(!activeProfile?.id || !state) return;
      clearTimeout(persistTimer);
      persistTimer = setTimeout(()=> {
        try{ saveStateForProfile(activeProfile.id, state); }catch(e){}
      }, 250);
    }
    function persist(){ // immediate (for critical operations)
      if(!activeProfile?.id || !state) return;
      try{ saveStateForProfile(activeProfile.id, state); }catch(e){}
    }

    // Lockout per profile
    function lockKey(profileId){ return "cashcontrol_pinlock_v1__" + profileId; }
    function getLock(profileId){
      try{ return JSON.parse(localStorage.getItem(lockKey(profileId))||"null"); }catch(e){ return null; }
    }
    function setLock(profileId, obj){ localStorage.setItem(lockKey(profileId), JSON.stringify(obj)); }
    function clearLock(profileId){ localStorage.removeItem(lockKey(profileId)); }
    function isLocked(profileId){
      const l = getLock(profileId);
      if(!l?.until) return {locked:false};
      const until = Number(l.until)||0;
      const now = Date.now();
      if(now >= until) { clearLock(profileId); return {locked:false}; }
      return {locked:true, seconds: Math.ceil((until-now)/1000)};
    }
    function registerFail(profileId){
      const l = getLock(profileId) || {fails:0, until:0};
      l.fails = (Number(l.fails)||0) + 1;
      if(l.fails >= 5) l.until = Date.now() + 30_000;
      setLock(profileId, l);
      return l;
    }

    // Default categories (professional)
    function defaultCategories(){
      return {
        expense: {
          "–ñ–∏–ª–∏—â–µ": ["–ù–∞–µ–º","–ò–ø–æ—Ç–µ–∫–∞","–¢–æ–∫","–í–æ–¥–∞","–ü–∞—Ä–Ω–æ/–ì–∞–∑","–ò–Ω—Ç–µ—Ä–Ω–µ—Ç","–¢–∞–∫—Å–∞ –≤—Ö–æ–¥","–†–µ–º–æ–Ω—Ç–∏"],
          "–•—Ä–∞–Ω–∞": ["–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç","–†–µ—Å—Ç–æ—Ä–∞–Ω—Ç–∏","–î–æ—Å—Ç–∞–≤–∫–∞","–ö–∞—Ñ–µ/–ó–∞–∫—É—Å–∫–∏","–ö–µ—à"],
          "–ö–æ–ª–∞": ["–ì–æ—Ä–∏–≤–æ","–†–µ–º–æ–Ω—Ç–∏","–ß–∞—Å—Ç–∏","–ì—É–º–∏","–°–µ—Ä–≤–∏–∑","–ü–∞—Ä–∫–∏–Ω–≥/–¢–∞–∫—Å–∏","–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞","–ö–∞—Å–∫–æ","–î–∞–Ω—ä–∫","–í–∏–Ω–µ—Ç–∫–∞","–î—Ä—É–≥–æ"],
          "–°–º–µ—Ç–∫–∏": ["–¢–µ–ª–µ—Ñ–æ–Ω","Subscriptions","–î—Ä—É–≥–∏ —É—Å–ª—É–≥–∏"],
          "–ü–æ–∫—É–ø–∫–∏": ["–î—Ä–µ—Ö–∏","–ö–æ–∑–º–µ—Ç–∏–∫–∞","–ï–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞","–ü–æ–¥–∞—Ä—ä—Ü–∏","–û–Ω–ª–∞–π–Ω","–î—Ä—É–≥–æ"],
          "–ó–¥—Ä–∞–≤–µ": ["–ê–ø—Ç–µ–∫–∞","–õ–µ–∫–∞—Ä","–ó—ä–±–æ–ª–µ–∫–∞—Ä","–ò–∑—Å–ª–µ–¥–≤–∞–Ω–∏—è","–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"],
          "–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": ["–ò–∑–ª–∏–∑–∞–Ω–µ","–ö–∏–Ω–æ/–¢–µ–∞—Ç—ä—Ä","–°–ø–æ—Ä—Ç/–§–∏—Ç–Ω–µ—Å","–•–æ–±–∏","–ü—ä—Ç—É–≤–∞–Ω–∏—è"],
          "–§–∏–Ω–∞–Ω—Å–æ–≤–∏": ["–ö—Ä–µ–¥–∏—Ç–∏","–ë–∞–Ω–∫–æ–≤–∏ —Ç–∞–∫—Å–∏","–ì–ª–æ–±–∏","–î–∞–Ω—ä—Ü–∏"],
          "–°–µ–º–µ–π—Å—Ç–≤–æ": ["–î–µ—Ü–∞","–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ","–£—Ä–æ—Ü–∏","–î–æ–º. –ª—é–±–∏–º—Ü–∏"],
          "–î—Ä—É–≥–æ": ["–î—Ä—É–≥–æ"]
        },
        income: { "–î–æ—Ö–æ–¥": ["–ó–∞–ø–ª–∞—Ç–∞","–í–∞—É—á–µ—Ä–∏","–ë–æ–Ω—É—Å","–î—Ä—É–≥ –¥–æ—Ö–æ–¥"] },
        saving: { "–°–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è": ["–ê–≤–∞—Ä–∏–π–Ω–∏","–ë—É—Ñ–µ—Ä","–î—ä–ª–≥–æ—Å—Ä–æ—á–Ω–∏"] }
      };
    }

    function defaultState(){
      const nowYM = ymNow();
      return {
        version: STATE_VERSION,
        settings: { activeYM: nowYM, goal: 0, startSavings: 0, saveTarget: 0 },
        plan: { salary: 0, vouchers: 0 },
        categories: defaultCategories(),
        recurring: [],
        budgets: { expense: {} },
        credits: [],
        tx: []
      };
    }

    // Legacy helpers
    function splitLegacyCat(catStr){
      if(!catStr) return {cat:"–î—Ä—É–≥–æ", subcat:"–î—Ä—É–≥–æ"};
      const s = String(catStr);
      const i = s.indexOf(":");
      if(i === -1) return {cat:s, subcat:"–î—Ä—É–≥–æ"};
      return {cat:s.slice(0,i).trim(), subcat:s.slice(i+1).trim() || "–î—Ä—É–≥–æ"};
    }
    function migrateTxCatsToSubcats(s){
      if(!s?.tx) return s;
      for(const t of s.tx){
        if(!t) continue;
        if(t.subcat) continue;

        if(t.cat && String(t.cat).includes(":")){
          const p = splitLegacyCat(t.cat);
          t.cat = p.cat;
          t.subcat = p.subcat;
        } else {
          const legacy = String(t.cat || "–î—Ä—É–≥–æ");
          if(legacy === "–ì–æ—Ä–∏–≤–æ"){
            t.cat = "–ö–æ–ª–∞"; t.subcat = "–ì–æ—Ä–∏–≤–æ";
          } else if(legacy === "–ö–æ–º—É–Ω–∞–ª–Ω–∏"){
            t.cat = "–ñ–∏–ª–∏—â–µ"; t.subcat = "–¢–æ–∫";
          } else {
            t.subcat = "–î—Ä—É–≥–æ";
          }
        }
      }
      return s;
    }

    function migrateAutoToRecurring(s){
      // If user imports old profiles with s.auto.* fields, convert them to recurring.
      if(!s || typeof s !== "object") return s;
      if(!Array.isArray(s.recurring)) s.recurring = [];
      if(!s.auto) return s;

      const a = s.auto;
      const pushExp = (name, cat, subcat, amt, every="monthly", anchorYM=ymNow())=>{
        amt = Number(amt)||0;
        if(amt<=0) return;
        s.recurring.push({
          id: uuid(),
          name,
          type: "expense",
          cat,
          subcat,
          amt,
          every,
          anchorYM,
          endYM: null
        });
      };

      pushExp("–ö–æ–º—É–Ω–∞–ª–Ω–∏", "–ñ–∏–ª–∏—â–µ", "–¢–æ–∫", a.utilities);
      pushExp("–¢–µ–ª–µ—Ñ–æ–Ω", "–°–º–µ—Ç–∫–∏", "–¢–µ–ª–µ—Ñ–æ–Ω", a.phone);
      pushExp("Subscriptions", "–°–º–µ—Ç–∫–∏", "Subscriptions", a.subscriptions);

      if(Number(a.insuranceAmount)>0){
        pushExp("–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞", "–ö–æ–ª–∞", "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞", a.insuranceAmount, "q3", a.insuranceAnchorYM || ymNow());
      }

      if(a.includePlansAsAuto==="yes"){
        pushExp("–ü–ª–∞–Ω –ì–æ—Ä–∏–≤–æ", "–ö–æ–ª–∞", "–ì–æ—Ä–∏–≤–æ", a.fuelPlan);
        pushExp("–ü–ª–∞–Ω –•—Ä–∞–Ω–∞", "–•—Ä–∞–Ω–∞", "–ö–µ—à", a.foodPlan);
      }

      // Optionally: move old autoSaveTarget into settings.saveTarget
      if(typeof a.autoSaveTarget === "number" && (Number(s.settings?.saveTarget)||0)===0){
        s.settings = s.settings || {};
        s.settings.saveTarget = Number(a.autoSaveTarget)||0;
      }

      return s;
    }

    function migrateStateIfNeeded(s){
      if(!s || typeof s !== "object") return defaultState();
      if(!s.version) s.version = 1;

      // Bring missing keys forward
      if(!s.settings) s.settings = { activeYM: ymNow(), goal:0, startSavings:0, saveTarget:0 };
      if(typeof s.settings.saveTarget !== "number") s.settings.saveTarget = 0;
      if(!s.plan) s.plan = { salary:0, vouchers:0 };
      if(!s.categories) s.categories = defaultCategories();
      if(!Array.isArray(s.recurring)) s.recurring = [];
      if(!s.budgets) s.budgets = { expense:{} };
      if(!s.budgets.expense) s.budgets.expense = {};
      if(!Array.isArray(s.credits)) s.credits = [];
      if(!Array.isArray(s.tx)) s.tx = [];

      // v1/v2 legacy migrations
      s = migrateTxCatsToSubcats(s);
      s = migrateAutoToRecurring(s);

      s.version = STATE_VERSION;
      return s;
    }

    function sanitizeState(s){
      const d = defaultState();
      s = migrateStateIfNeeded(s);

      // Clone to safe structure
      const out = structuredClone(d);

      out.version = STATE_VERSION;

      out.settings.activeYM = (typeof s.settings?.activeYM === "string" && s.settings.activeYM.length===7) ? s.settings.activeYM : d.settings.activeYM;
      out.settings.goal = toMoney(s.settings?.goal);
      out.settings.startSavings = toMoney(s.settings?.startSavings);
      out.settings.saveTarget = toMoney(s.settings?.saveTarget);

      out.plan.salary = toMoney(s.plan?.salary);
      out.plan.vouchers = toMoney(s.plan?.vouchers);

      // categories: trust only object-of-arrays strings
      out.categories = d.categories;
      if(s.categories && typeof s.categories==="object"){
        for(const t of ["expense","income","saving"]){
          if(!s.categories[t] || typeof s.categories[t] !== "object") continue;
          const mapped = {};
          for(const [cat, subs] of Object.entries(s.categories[t])){
            if(typeof cat !== "string") continue;
            if(!Array.isArray(subs)) continue;
            mapped[clampText(cat,40)] = subs.filter(x=>typeof x==="string").map(x=>clampText(x,40)).slice(0,60);
          }
          if(Object.keys(mapped).length) out.categories[t] = mapped;
        }
      }

      out.budgets = { expense:{} };
      if(s.budgets?.expense && typeof s.budgets.expense==="object"){
        for(const [cat,val] of Object.entries(s.budgets.expense)){
          out.budgets.expense[clampText(cat,40)] = toMoney(val);
        }
      }

      out.recurring = Array.isArray(s.recurring) ? s.recurring.slice(0,1000).map(r=>({
        id: r.id || uuid(),
        name: clampText(r.name, 60),
        type: ["income","expense","saving"].includes(r.type) ? r.type : "expense",
        cat: clampText(r.cat, 40) || "–î—Ä—É–≥–æ",
        subcat: clampText(r.subcat, 40) || "–î—Ä—É–≥–æ",
        amt: toMoney(r.amt),
        every: ["monthly","q3","q6","yearly"].includes(r.every) ? r.every : "monthly",
        anchorYM: (typeof r.anchorYM==="string" && r.anchorYM.length===7) ? r.anchorYM : ymNow(),
        endYM: (typeof r.endYM==="string" && r.endYM.length===7) ? r.endYM : null
      })) : [];

      out.credits = Array.isArray(s.credits) ? s.credits.slice(0,500).map(c=>({
        id: c.id || uuid(),
        name: clampText(c.name, 40),
        pay: toMoney(c.pay),
        startYM: (typeof c.startYM==="string" && c.startYM.length===7) ? c.startYM : ymNow(),
        endYM: (typeof c.endYM==="string" && c.endYM.length===7) ? c.endYM : null,
        mode: (c.mode === "saving") ? "saving" : "expense",
        note: clampText(c.note, 200),
      })) : [];

      out.tx = Array.isArray(s.tx) ? s.tx.slice(0,5000).map(t=>({
        id: t.id || uuid(),
        date: clampText(t.date, 10),
        ym: (typeof t.ym==="string" && t.ym.length===7) ? t.ym : (ymFromDate(t.date) || ymNow()),
        type: ["income","expense","saving"].includes(t.type) ? t.type : "expense",
        cat: clampText(t.cat, 40) || "–î—Ä—É–≥–æ",
        subcat: clampText(t.subcat, 40) || "–î—Ä—É–≥–æ",
        amt: toMoney(t.amt),
        note: clampText(t.note, 200),
      })) : [];

      return out;
    }

    let activeProfile = null; // {id,name,pinHash?,pinSalt?}
    let state = null;

    // =========================
    // Overlay UI
    // =========================
    const profileOverlay = byId("profileOverlay");
    const profileList = byId("profileList");
    const btnProfiles = byId("btnProfiles");
    const profileNameLine = byId("profileNameLine");

    const btnShowCreate = byId("btnShowCreate");
    const createBox = byId("createBox");
    const newName = byId("newName");
    const newPin = byId("newPin");
    const btnCreate = byId("btnCreate");
    const btnCancelCreate = byId("btnCancelCreate");

    const loginBox = byId("loginBox");
    const loginHint = byId("loginHint");
    const loginPin = byId("loginPin");
    const btnLogin = byId("btnLogin");
    const btnCancelLogin = byId("btnCancelLogin");
    const loginLockHint = byId("loginLockHint");
    let pendingLoginProfileId = null;

    const btnOverlayImport = byId("btnOverlayImport");
    const overlayImportFile = byId("overlayImportFile");

    function showOverlay(){
      document.body.style.overflow="hidden";
      profileOverlay.style.display="block";
      createBox.style.display="none";
      loginBox.style.display="none";
      loginLockHint.style.display="none";
      newName.value=""; newPin.value=""; loginPin.value="";
      pendingLoginProfileId=null;
      renderProfileList();
    }
    function hideOverlay(){
      document.body.style.overflow="";
      profileOverlay.style.display="none";
    }
    btnProfiles.onclick = showOverlay;

    btnShowCreate.onclick=()=>{
      createBox.style.display="block";
      loginBox.style.display="none";
      loginLockHint.style.display="none";
      newName.focus();
    };
    btnCancelCreate.onclick=()=>{ createBox.style.display="none"; };

    btnCancelLogin.onclick=()=>{
      loginBox.style.display="none";
      loginLockHint.style.display="none";
      pendingLoginProfileId=null;
      loginPin.value="";
    };

    function renderProfileList(){
      const profiles = loadProfiles();
      profileList.textContent = "";
      if(!profiles.length){
        profileList.appendChild(el("div","small","–ù—è–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏. –°—ä–∑–¥–∞–π –ø—ä—Ä–≤–∏—è –æ—Ç ‚Äû–ù–æ–≤ –ø—Ä–æ—Ñ–∏–ª‚Äú."));
        return;
      }

      for(const p of profiles){
        const needsPin = !!p.pinHash;
        const item = el("div","item");

        const meta = el("div","meta");
        meta.appendChild(el("div","t", p.name));
        const last = p.lastUsed ? ("–ü–æ—Å–ª–µ–¥–Ω–æ: " + p.lastUsed) : "";
        meta.appendChild(el("div","s", `${needsPin ? "üîí PIN" : "–ë–µ–∑ PIN"}${last ? " ‚Ä¢ "+last : ""}`));

        const actions = document.createElement("div");
        actions.style.display="flex";
        actions.style.flexDirection="column";
        actions.style.gap="8px";
        actions.style.minWidth="140px";

        const openBtn = el("button","secondary","–í—Ö–æ–¥"); openBtn.type="button";
        const delBtn  = el("button","danger","–ò–∑—Ç—Ä–∏–π"); delBtn.type="button";
        openBtn.dataset.act="open"; openBtn.dataset.id=p.id;
        delBtn.dataset.act="del";   delBtn.dataset.id=p.id;

        actions.appendChild(openBtn);
        actions.appendChild(delBtn);

        item.appendChild(meta);
        item.appendChild(actions);
        profileList.appendChild(item);
      }

      profileList.querySelectorAll("button").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;

          const profiles = loadProfiles();
          const p = profiles.find(x=>x.id===id);
          if(!p) return;

          if(act==="del"){
            if(confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è –ø—Ä–æ—Ñ–∏–ª "${p.name}"? –¢–æ–≤–∞ –∏–∑—Ç—Ä–∏–≤–∞ –∏ –≤—Å–∏—á–∫–∏—Ç–µ –º—É –¥–∞–Ω–Ω–∏.`)){
              saveProfiles(profiles.filter(x=>x.id!==id));
              localStorage.removeItem(profileStoreKey(id));
              clearLock(id);
              if(getActiveProfileId()===id){
                setActiveProfileId("");
                activeProfile=null;
                state=null;
              }
              renderProfileList();
            }
            return;
          }

          if(act==="open"){
            if(p.pinHash){
              pendingLoginProfileId=id;
              loginHint.textContent = `–ü—Ä–æ—Ñ–∏–ª: ${p.name}`;

              const lock = isLocked(id);
              loginBox.style.display="block";
              createBox.style.display="none";
              loginPin.value="";
              if(lock.locked){
                loginPin.disabled=true;
                btnLogin.disabled=true;
                loginLockHint.style.display="block";
                loginLockHint.textContent=`‚è≥ –ó–∞–∫–ª—é—á–µ–Ω–æ –∑–∞ ${lock.seconds}s (—Ç–≤—ä—Ä–¥–µ –º–Ω–æ–≥–æ –≥—Ä–µ—à–Ω–∏ –æ–ø–∏—Ç–∏).`;
                setTimeout(()=>{
                  const lk=isLocked(id);
                  if(!lk.locked){
                    loginPin.disabled=false; btnLogin.disabled=false;
                    loginLockHint.style.display="none";
                    loginPin.focus();
                  }
                }, lock.seconds*1000 + 80);
                return;
              }

              loginPin.disabled=false;
              btnLogin.disabled=false;
              loginLockHint.style.display="none";
              loginPin.focus();
            } else {
              await activateProfile(id);
              hideOverlay();
            }
          }
        };
      });
    }

    btnCreate.onclick = async ()=>{
      const name = (newName.value||"").trim();
      const pin  = (newPin.value||"").trim();
      if(!name) return alert("–í—ä–≤–µ–¥–∏ –∏–º–µ.");

      const profiles = loadProfiles();
      if(profiles.some(p=>p.name.toLowerCase()===name.toLowerCase())){
        if(!confirm("–ò–º–∞ –ø—Ä–æ—Ñ–∏–ª —Å—ä—Å —Å—ä—â–æ—Ç–æ –∏–º–µ. –î–∞ –ø—Ä–æ–¥—ä–ª–∂–∞?")) return;
      }

      const id = uuid();

      let pinSalt=null, pinHash=null;
      if(pin){
        pinSalt = randomSalt();
        pinHash = await hashPin(pin, pinSalt);
      }

      profiles.push({
        id,
        name,
        pinHash: pinHash || null,
        pinSalt: pinSalt || null,
        createdAt: new Date().toISOString().slice(0,10),
        lastUsed: ""
      });
      saveProfiles(profiles);

      saveStateForProfile(id, defaultState());

      await activateProfile(id);
      hideOverlay();
    };

    btnLogin.onclick = async ()=>{
      const id = pendingLoginProfileId;
      const profiles = loadProfiles();
      const p = profiles.find(x=>x.id===id);
      if(!p) return alert("–ü—Ä–æ—Ñ–∏–ª—ä—Ç –ª–∏–ø—Å–≤–∞.");

      const lock = isLocked(id);
      if(lock.locked) return alert(`–ó–∞–∫–ª—é—á–µ–Ω–æ –∑–∞ ${lock.seconds}s. –û–ø–∏—Ç–∞–π –ø–∞–∫ —Å–ª–µ–¥ –º–∞–ª–∫–æ.`);

      const pin = (loginPin.value||"").trim();
      const h = await hashPin(pin, p.pinSalt || "");
      if(h !== p.pinHash){
        const l = registerFail(id);
        if((l.fails||0) >= 5) alert("–¢–≤—ä—Ä–¥–µ –º–Ω–æ–≥–æ –≥—Ä–µ—à–Ω–∏ –æ–ø–∏—Ç–∏. –ó–∞–∫–ª—é—á–µ–Ω–æ –∑–∞ 30 —Å–µ–∫—É–Ω–¥–∏.");
        else alert("–ì—Ä–µ—à–µ–Ω PIN.");
        return;
      }

      clearLock(id);
      await activateProfile(id);
      hideOverlay();
    };

    loginPin.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnLogin.click(); });
    newName.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnCreate.click(); });
    newPin.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnCreate.click(); });

    async function activateProfile(id){
      const profiles = loadProfiles();
      const p = profiles.find(x=>x.id===id);
      if(!p) return alert("–ü—Ä–æ—Ñ–∏–ª—ä—Ç –ª–∏–ø—Å–≤–∞.");

      let s = loadStateForProfile(id);
      if(!s) s = defaultState();

      s = sanitizeState(s);
      saveStateForProfile(id, s);

      p.lastUsed = new Date().toISOString().slice(0,10);
      saveProfiles(profiles);

      activeProfile = p;
      state = s;
      setActiveProfileId(id);

      profileNameLine.textContent = "–ü—Ä–æ—Ñ–∏–ª: " + p.name;
      render();
    }

    // Import from overlay
    btnOverlayImport.onclick = ()=> overlayImportFile.click();
    overlayImportFile.onchange = async ()=>{
      const f = overlayImportFile.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const parsed = JSON.parse(text);

        if(!parsed?.profile?.name || !parsed?.state) throw new Error("bad");

        const profiles = loadProfiles();
        const id = uuid();

        profiles.push({
          id,
          name: (parsed.profile.name||"–ò–º–ø–æ—Ä—Ç").trim(),
          pinHash: parsed.profile.pinHash || null,
          pinSalt: parsed.profile.pinSalt || null,
          createdAt: new Date().toISOString().slice(0,10),
          lastUsed: ""
        });
        saveProfiles(profiles);

        const migrated = sanitizeState(parsed.state);
        saveStateForProfile(id, migrated);

        await activateProfile(id);
        hideOverlay();
        alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ ‚úÖ");
      }catch(e){
        alert("–ù–µ—É—Å–ø–µ—à–µ–Ω –∏–º–ø–æ—Ä—Ç. –£–≤–µ—Ä–∏ —Å–µ, —á–µ —Ñ–∞–π–ª—ä—Ç –µ Export –æ—Ç CashControl.");
      }finally{
        overlayImportFile.value="";
      }
    };

    function ensureProfileOnStart(){
      const id = getActiveProfileId();
      const profiles = loadProfiles();
      if(id && profiles.some(p=>p.id===id)){
        const p = profiles.find(x=>x.id===id);
        if(p.pinHash){
          showOverlay();
          pendingLoginProfileId=id;
          loginHint.textContent=`–ü—Ä–æ—Ñ–∏–ª: ${p.name}`;
          loginBox.style.display="block";
          createBox.style.display="none";
          setTimeout(()=>loginPin.focus(), 50);
        } else {
          activateProfile(id);
        }
      } else {
        showOverlay();
      }
    }

    // =========================
    // APP UI refs
    // =========================
    const tabs = {
      dash: byId("tabDash"),
      add: byId("tabAdd"),
      recurring: byId("tabRecurring"),
      credits: byId("tabCredits"),
      car: byId("tabCar"),
      plan: byId("tabPlan"),
      reports: byId("tabReports"),
      settings: byId("tabSettings")
    };
    const views = {
      dash: byId("viewDash"),
      add: byId("viewAdd"),
      recurring: byId("viewRecurring"),
      credits: byId("viewCredits"),
      car: byId("viewCar"),
      plan: byId("viewPlan"),
      reports: byId("viewReports"),
      settings: byId("viewSettings")
    };

    function setTab(activeKey){
      for(const k of Object.keys(tabs)){
        tabs[k].classList.toggle("active", k===activeKey);
        views[k].style.display = (k===activeKey) ? "grid" : "none";
      }
      if(activeKey==="reports") setTimeout(rebuildReportsCharts, 50);
      if(activeKey==="dash") setTimeout(rebuildDashCharts, 50);
      if(activeKey==="car") setTimeout(rebuildCarChart, 50);
    }
    tabs.dash.onclick=()=>setTab("dash");
    tabs.add.onclick=()=>setTab("add");
    tabs.recurring.onclick=()=>setTab("recurring");
    tabs.credits.onclick=()=>setTab("credits");
    tabs.car.onclick=()=>setTab("car");
    tabs.plan.onclick=()=>setTab("plan");
    tabs.reports.onclick=()=>setTab("reports");
    tabs.settings.onclick=()=>setTab("settings");

    const monthPill = byId("monthPill");
    const selMonth = byId("selMonth");
    const alertBox = byId("alertBox");

    const kIncome = byId("kIncome");
    const kExpense = byId("kExpense");
    const kSavings = byId("kSavings");
    const kNet = byId("kNet");
    const kIncomeNote = byId("kIncomeNote");
    const kExpenseNote = byId("kExpenseNote");
    const kNetNote = byId("kNetNote");

    const kGoal = byId("kGoal");
    const kGoalNow = byId("kGoalNow");
    const goalBar = byId("goalBar");
    const goalProgressTxt = byId("goalProgressTxt");

    const momList = byId("momList");
    const leaksList = byId("leaksList");
    const budgetProgress = byId("budgetProgress");

    const txList = byId("txList");
    const txListManage = byId("txListManage");

    const autoListDash = byId("autoListDash");
    const autoHintDash = byId("autoHintDash");

    // Add TX
    const txDate = byId("txDate");
    const txType = byId("txType");
    const txCat = byId("txCat");
    const txSubcat = byId("txSubcat");
    const txAmt = byId("txAmt");
    const txNote = byId("txNote");
    const btnAddTx = byId("btnAddTx");
    const btnClearTx = byId("btnClearTx");
    const quickSalary = byId("quickSalary");
    const quickVouchers = byId("quickVouchers");
    const quickFuel = byId("quickFuel");

    // Recurring
    const recName = byId("recName");
    const recType = byId("recType");
    const recAmt = byId("recAmt");
    const recCat = byId("recCat");
    const recSubcat = byId("recSubcat");
    const recEvery = byId("recEvery");
    const recAnchor = byId("recAnchor");
    const recEnd = byId("recEnd");
    const btnAddRec = byId("btnAddRec");
    const recList = byId("recList");

    // Credits
    const crName = byId("crName");
    const crPay = byId("crPay");
    const crStart = byId("crStart");
    const crEnd = byId("crEnd");
    const crMode = byId("crMode");
    const crNote = byId("crNote");
    const btnSaveCredit = byId("btnSaveCredit");
    const btnNewCredit = byId("btnNewCredit");
    const creditList = byId("creditList");
    let editingCreditId=null;

    // Car
    const carThisMonth = byId("carThisMonth");
    const carHint = byId("carHint");

    // Plan
    const planSalary = byId("planSalary");
    const planVouchers = byId("planVouchers");
    const btnSavePlan = byId("btnSavePlan");
    const forecastList = byId("forecastList");

    // Settings
    const setGoal = byId("setGoal");
    const setStart = byId("setStart");
    const setSaveTarget = byId("setSaveTarget");
    const btnSaveSettings = byId("btnSaveSettings");

    // Budgets
    const budCat = byId("budCat");
    const budAmt = byId("budAmt");
    const btnSaveBudget = byId("btnSaveBudget");
    const btnDeleteBudget = byId("btnDeleteBudget");
    const budList = byId("budList");

    // Profile actions
    const btnSwitchProfile = byId("btnSwitchProfile");
    const btnLogout = byId("btnLogout");
    const btnExportProfile = byId("btnExportProfile");
    const btnImportProfile = byId("btnImportProfile");
    const importProfileFile = byId("importProfileFile");
    const btnReset = byId("btnReset");

    // Charts
    let chartCum=null, chartNet=null, chartCats=null, chartCar=null;

    // =========================
    // Category helpers
    // =========================
    function catMap(type){
      return state?.categories?.[type] || {};
    }
    function fillTxCats(){
      const map = catMap(txType.value);
      txCat.innerHTML="";
      const keys = Object.keys(map);
      for(const k of keys){
        const o=document.createElement("option");
        o.value=k; o.textContent=k;
        txCat.appendChild(o);
      }
      if(keys.length) txCat.value = keys[0];
      fillTxSubcats();
    }
    function fillTxSubcats(){
      const map = catMap(txType.value);
      const subs = map[txCat.value] || ["–î—Ä—É–≥–æ"];
      txSubcat.innerHTML="";
      for(const s of subs){
        const o=document.createElement("option");
        o.value=s; o.textContent=s;
        txSubcat.appendChild(o);
      }
      txSubcat.value = subs[0] || "–î—Ä—É–≥–æ";
    }

    function fillRecCats(){
      const map = catMap(recType.value);
      recCat.innerHTML="";
      const keys = Object.keys(map);
      for(const k of keys){
        const o=document.createElement("option");
        o.value=k; o.textContent=k;
        recCat.appendChild(o);
      }
      if(keys.length) recCat.value = keys[0];
      fillRecSubcats();
    }
    function fillRecSubcats(){
      const map = catMap(recType.value);
      const subs = map[recCat.value] || ["–î—Ä—É–≥–æ"];
      recSubcat.innerHTML="";
      for(const s of subs){
        const o=document.createElement("option");
        o.value=s; o.textContent=s;
        recSubcat.appendChild(o);
      }
      recSubcat.value = subs[0] || "–î—Ä—É–≥–æ";
    }

    // =========================
    // Month options
    // =========================
    function ensureMonthOptions(){
      const opts=new Set();
      const start=addMonths(ymNow(), -23);
      for(let i=0;i<24;i++) opts.add(addMonths(start,i));

      for(const t of state.tx) if(t.ym) opts.add(t.ym);
      for(const c of state.credits){
        if(c.startYM) opts.add(c.startYM);
        if(c.endYM) opts.add(c.endYM);
      }
      for(const r of state.recurring){
        if(r.anchorYM) opts.add(r.anchorYM);
        if(r.endYM) opts.add(r.endYM);
      }

      const arr=Array.from(opts).filter(Boolean).sort((a,b)=>b.localeCompare(a));
      selMonth.innerHTML="";
      for(const v of arr){
        const o=document.createElement("option");
        o.value=v; o.textContent=ymToLabel(v);
        selMonth.appendChild(o);
      }
      if(!state.settings.activeYM || !arr.includes(state.settings.activeYM)) state.settings.activeYM=arr[0]||ymNow();
      selMonth.value=state.settings.activeYM;
    }

    function monthTx(ymStr){ return state.tx.filter(t=>t.ym===ymStr); }
    function inRange(startYM,endYM,ymStr){
      if(!startYM) return false;
      if(ymStr<startYM) return false;
      if(endYM && ymStr>endYM) return false;
      return true;
    }
    function creditsForMonth(ymStr){ return state.credits.filter(c=>inRange(c.startYM,c.endYM,ymStr)); }

    // =========================
    // Recurring engine
    // =========================
    function recurringDue(item, ymStr){
      const anchor = item.anchorYM || ymNow();
      const [ay,am]=anchor.split("-").map(Number);
      const [y,m]=ymStr.split("-").map(Number);
      const diff=(y-ay)*12+(m-am);
      if(diff < 0) return false;
      if(item.endYM && ymStr > item.endYM) return false;

      const every = item.every || "monthly";
      const mod = every==="monthly" ? 1 : every==="q3" ? 3 : every==="q6" ? 6 : 12;
      return diff % mod === 0;
    }
    function recurringForMonth(ymStr){
      const out=[];
      for(const it of (state.recurring||[])){
        const amt = Number(it.amt)||0;
        if(amt>0 && recurringDue(it, ymStr)) out.push(it);
      }
      return out;
    }

    // =========================
    // Compute month summary
    // =========================
    function computeMonth(ymStr){
      const tx=monthTx(ymStr);

      let incomeTx=0, expenseTx=0, savingTx=0;
      const expByCat = {};
      const addExpCat = (cat, amt)=>{ expByCat[cat]=(expByCat[cat]||0)+amt; };

      for(const t of tx){
        const a=Number(t.amt)||0;
        if(t.type==="income") incomeTx+=a;
        else if(t.type==="expense"){ expenseTx+=a; addExpCat(t.cat, a); }
        else if(t.type==="saving") savingTx+=a;
      }

      const cr=creditsForMonth(ymStr);
      let creditExpense=0, creditSaving=0;
      for(const c of cr){
        const p=Number(c.pay)||0;
        if(c.mode==="saving") creditSaving += p;
        else { creditExpense+=p; addExpCat("–§–∏–Ω–∞–Ω—Å–æ–≤–∏", p); }
      }

      const rec = recurringForMonth(ymStr);
      let recIncome=0, recExpense=0, recSaving=0;
      for(const r of rec){
        const a = Number(r.amt)||0;
        if(r.type==="income") recIncome += a;
        else if(r.type==="saving") recSaving += a;
        else { recExpense += a; addExpCat(r.cat, a); }
      }

      const income = incomeTx + recIncome;
      const expense = expenseTx + creditExpense + recExpense;
      const savings = savingTx + recSaving + creditSaving;
      const net = income - expense - savings;

      return {
        income, expense, savings, net,
        incomeTx, expenseTx, savingTx,
        creditExpense, creditSaving,
        recIncome, recExpense, recSaving,
        recurring: rec,
        credits: cr,
        expByCat
      };
    }

    function totalSavings(){
      let s=Number(state.settings.startSavings)||0;
      // include tx savings
      for(const t of state.tx) if(t.type==="saving") s+=Number(t.amt)||0;
      // include recurring savings (for months from start window) ‚Äî to keep simple, we DON'T accumulate recurring historically here
      // You can add later if desired; dashboard "goal now" remains based on explicit savings transactions.
      return s;
    }

    // =========================
    // CAR computations (category-based)
    // =========================
    function computeCarMonth(ymStr){
      const tx = monthTx(ymStr).filter(t=>t.type==="expense" && t.cat==="–ö–æ–ª–∞");
      const by = {};
      for(const t of tx){
        const k = t.subcat || "–î—Ä—É–≥–æ";
        by[k] = (by[k]||0) + (Number(t.amt)||0);
      }

      // include recurring expenses where cat === "–ö–æ–ª–∞"
      const rec = recurringForMonth(ymStr).filter(r=>r.type==="expense" && r.cat==="–ö–æ–ª–∞");
      for(const r of rec){
        const k = r.subcat || "–î—Ä—É–≥–æ";
        by[k] = (by[k]||0) + (Number(r.amt)||0);
      }

      const total = Object.values(by).reduce((a,b)=>a+b,0);
      return {by,total};
    }

    function renderCarMonth(){
      const ymStr = state.settings.activeYM;
      const {by,total} = computeCarMonth(ymStr);

      carThisMonth.textContent="";
      if(!total){
        carThisMonth.appendChild(el("div","small","–ù—è–º–∞ —Ä–∞–∑—Ö–æ–¥–∏ –∑–∞ –∫–æ–ª–∞ —Ç–æ–∑–∏ –º–µ—Å–µ—Ü."));
        carHint.textContent="";
        return;
      }
      const entries = Object.entries(by).sort((a,b)=>b[1]-a[1]);
      for(const [sub,amt] of entries){
        const item = el("div","item");
        const meta = el("div","meta");
        meta.appendChild(el("div","t", sub));
        meta.appendChild(el("div","s","–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ö–æ–ª–∞"));
        item.appendChild(meta);
        item.appendChild(el("div","amt out","‚àí "+fmt.format(amt)));
        carThisMonth.appendChild(item);
      }
      carHint.textContent = "–û–±—â–æ: " + fmt.format(total);
    }

    // =========================
    // Dash: Alerts + MoM + Leaks + Budgets
    // =========================
    function renderAlerts(info){
      alertBox.style.display="none";
      alertBox.classList.remove("bad");

      const msgs=[];
      if(info.net < 0){
        msgs.push("‚ö†Ô∏è –ü—Ä–µ—Ä–∞–∑—Ö–æ–¥ (–Ω–µ—Ç–Ω–æ—Ç–æ –µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–Ω–æ).");
        alertBox.classList.add("bad");
      }

      // Budget exceed
      const budgets = state.budgets?.expense || {};
      for(const [cat,limit] of Object.entries(budgets)){
        const lim = Number(limit)||0;
        if(lim<=0) continue;
        const spent = Number(info.expByCat?.[cat] || 0);
        if(spent > lim){
          msgs.push(`‚ö†Ô∏è "${cat}" ${fmt.format(spent)} –Ω–∞–¥ –±—é–¥–∂–µ—Ç–∞ ${fmt.format(lim)}.`);
        }
      }

      if(msgs.length){
        alertBox.style.display="block";
        alertBox.textContent="";
        alertBox.appendChild(el("div",null,"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è"));
        const lines = el("div","small", msgs.map(m=>"‚Ä¢ "+m).join("\n"));
        lines.style.marginTop="6px";
        lines.style.whiteSpace="pre-line";
        alertBox.appendChild(lines);
      }
    }

    function pctChange(cur, prev){
      cur = Number(cur)||0;
      prev = Number(prev)||0;
      if(prev === 0){
        if(cur === 0) return {label:"0%", trend:"flat"};
        return {label:"‚àû", trend:"up"};
      }
      const p = ((cur - prev) / Math.abs(prev)) * 100;
      const trend = p > 0.5 ? "up" : p < -0.5 ? "down" : "flat";
      return {label: `${p>0?"+":""}${p.toFixed(0)}%`, trend};
    }
    function trendIcon(trend){
      return trend==="up" ? "‚¨ÜÔ∏è" : trend==="down" ? "‚¨áÔ∏è" : "‚ûñ";
    }

    function renderMoM(activeYM){
      const prevYM = addMonths(activeYM, -1);
      const cur = computeMonth(activeYM);
      const prev = computeMonth(prevYM);

      momList.textContent="";

      const rows = [
        {label:"–î–æ—Ö–æ–¥–∏", cur:cur.income, prev:prev.income, goodWhen:"up"},
        {label:"–†–∞–∑—Ö–æ–¥–∏", cur:cur.expense, prev:prev.expense, goodWhen:"down"},
        {label:"–ù–µ—Ç–Ω–æ", cur:cur.net, prev:prev.net, goodWhen:"up"},
      ];

      for(const r of rows){
        const ch = pctChange(r.cur, r.prev);
        const icon = trendIcon(ch.trend);

        let cls="warn";
        if(ch.trend==="flat") cls="warn";
        else if(r.goodWhen==="up") cls = (ch.trend==="up") ? "good" : "bad";
        else cls = (ch.trend==="down") ? "good" : "bad";

        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", r.label));
        meta.appendChild(el("div","s", `${ymToLabel(prevYM)} ‚Üí ${ymToLabel(activeYM)} ‚Ä¢ ${fmt.format(r.prev)} ‚Üí ${fmt.format(r.cur)}`));
        item.appendChild(meta);
        item.appendChild(el("div",`amt ${cls}`, `${icon} ${ch.label}`));
        momList.appendChild(item);
      }
    }

    function renderLeaks(activeYM){
      const prevYM = addMonths(activeYM, -1);
      const cur = computeMonth(activeYM);
      const prev = computeMonth(prevYM);

      leaksList.textContent="";

      const allCats = new Set([
        ...Object.keys(cur.expByCat || {}),
        ...Object.keys(prev.expByCat || {})
      ]);

      const diffs=[];
      for(const cat of allCats){
        const c = Number(cur.expByCat?.[cat] || 0);
        const p = Number(prev.expByCat?.[cat] || 0);
        const d = c - p;
        if(d > 5) diffs.push({cat, cur:c, prev:p, diff:d});
      }

      diffs.sort((a,b)=>b.diff-a.diff);
      const top = diffs.slice(0,3);

      if(!top.length){
        leaksList.appendChild(el("div","small","–ù—è–º–∞ –∑–Ω–∞—á–∏–º —Ä—ä—Å—Ç —Å–ø—Ä—è–º–æ –º–∏–Ω–∞–ª–∏—è –º–µ—Å–µ—Ü ‚úÖ"));
        return;
      }

      for(const x of top){
        const ch = pctChange(x.cur, x.prev);
        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", x.cat));
        meta.appendChild(el("div","s", `${fmt.format(x.prev)} ‚Üí ${fmt.format(x.cur)} ‚Ä¢ –†—ä—Å—Ç: ${fmt.format(x.diff)}`));
        item.appendChild(meta);
        item.appendChild(el("div","amt bad", `‚¨ÜÔ∏è ${ch.label}`));
        leaksList.appendChild(item);
      }
    }

    function renderBudgetProgress(info){
      budgetProgress.textContent="";

      const budgets = state.budgets?.expense || {};
      const entries = Object.entries(budgets)
        .map(([cat,lim])=>({cat, lim:Number(lim)||0, spent:Number(info.expByCat?.[cat]||0)}))
        .filter(x=>x.lim>0)
        .sort((a,b)=>(b.spent/b.lim) - (a.spent/a.lim))
        .slice(0,6);

      if(!entries.length){
        budgetProgress.appendChild(el("div","small","–ù—è–º–∞ –±—é–¥–∂–µ—Ç–∏. –î–æ–±–∞–≤–∏ –æ—Ç ‚Äú–ù–∞—Å—Ç—Ä–æ–π–∫–∏‚Äù."));
        return;
      }

      for(const e of entries){
        const pct = Math.min(1, e.spent / e.lim);

        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", e.cat));
        meta.appendChild(el("div","s", `${fmt.format(e.spent)} / ${fmt.format(e.lim)} ‚Ä¢ ${(pct*100).toFixed(0)}%`));

        const barWrap=document.createElement("div");
        barWrap.style.height="8px";
        barWrap.style.background="#0b1430";
        barWrap.style.border="1px solid var(--border)";
        barWrap.style.borderRadius="999px";
        barWrap.style.overflow="hidden";
        barWrap.style.marginTop="8px";

        const bar=document.createElement("div");
        bar.style.height="100%";
        bar.style.width=(pct*100).toFixed(1)+"%";
        bar.style.background="linear-gradient(90deg,var(--good),var(--accent))";
        barWrap.appendChild(bar);

        meta.appendChild(barWrap);

        item.appendChild(meta);
        item.appendChild(el("div",`amt ${e.spent>e.lim ? "out":"in"}`, e.spent>e.lim ? "‚ö†Ô∏è" : "OK"));
        budgetProgress.appendChild(item);
      }
    }

    // =========================
    // Lists (transactions / recurring / credits / dash recurring)
    // =========================
    function titleCatSub(t){
      const c = t.cat || "–î—Ä—É–≥–æ";
      const s = t.subcat ? (" ‚Ä¢ " + t.subcat) : "";
      return c + s;
    }

    function renderTxList(ymStr){
      const arr=monthTx(ymStr).slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));
      txList.textContent="";
      const last=arr.slice(0,12);
      if(!last.length){
        txList.appendChild(el("div","small",'–ù—è–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –û—Ç–∏–¥–∏ –Ω–∞ ‚Äú–î–æ–±–∞–≤–∏‚Äù.'));
        return;
      }
      for(const t of last){
        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", titleCatSub(t)));
        meta.appendChild(el("div","s", `${t.date||""}${t.note?(" ‚Ä¢ "+t.note):""}`));

        const prefix=t.type==="income"?"+":(t.type==="expense"?"‚àí":"‚Üí");
        const cls=t.type==="income"?"in":(t.type==="expense"?"out":"warn");
        item.appendChild(meta);
        item.appendChild(el("div",`amt ${cls}`, `${prefix} ${fmt.format(Number(t.amt)||0)}`));
        txList.appendChild(item);
      }
    }

    function renderTxManage(ymStr){
      const arr=monthTx(ymStr).slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));
      txListManage.textContent="";
      if(!arr.length){
        txListManage.appendChild(el("div","small","–ù—è–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ —Ç–æ–∑–∏ –º–µ—Å–µ—Ü."));
        return;
      }

      for(const t of arr.slice(0,50)){
        const item=el("div","item");

        const meta=el("div","meta");
        meta.appendChild(el("div","t", titleCatSub(t)));
        meta.appendChild(el("div","s", `${t.date||""}${t.note?(" ‚Ä¢ "+t.note):""}`));

        const right=document.createElement("div");
        right.style.display="flex";
        right.style.flexDirection="column";
        right.style.gap="8px";
        right.style.alignItems="flex-end";

        const prefix=t.type==="income"?"+":(t.type==="expense"?"‚àí":"‚Üí");
        const cls=t.type==="income"?"in":(t.type==="expense"?"out":"warn");
        right.appendChild(el("div",`amt ${cls}`, `${prefix} ${fmt.format(Number(t.amt)||0)}`));

        const del=el("button","danger","–ò–∑—Ç—Ä–∏–π");
        del.type="button";
        del.style.padding="8px 10px";
        del.style.borderRadius="10px";
        del.onclick=()=>{
          if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ç–∞?")){
            state.tx = state.tx.filter(x=>x.id!==t.id);
            persistSoon();
            render();
          }
        };
        right.appendChild(del);

        item.appendChild(meta);
        item.appendChild(right);
        txListManage.appendChild(item);
      }
    }

    function everyLabel(v){
      return v==="monthly" ? "–º–µ—Å–µ—á–Ω–æ" : v==="q3" ? "–Ω–∞ 3 –º." : v==="q6" ? "–Ω–∞ 6 –º." : "–≥–æ–¥–∏—à–Ω–æ";
    }

    function renderRecurring(){
      recList.textContent="";
      const arr = state.recurring || [];
      if(!arr.length){
        recList.appendChild(el("div","small","–ù—è–º–∞ –ø–æ–≤—Ç–∞—Ä—è—â–∏ —Å–µ –∑–∞–ø–∏—Å–∏."));
        return;
      }

      const sorted = arr.slice().sort((a,b)=>a.name.localeCompare(b.name));
      for(const it of sorted){
        const item=el("div","item");

        const meta=el("div","meta");
        meta.appendChild(el("div","t", it.name));
        meta.appendChild(el("div","s",
          `${it.type} ‚Ä¢ ${it.cat} ‚Ä¢ ${it.subcat} ‚Ä¢ ${everyLabel(it.every)} ‚Ä¢ –∫–æ—Ç–≤–∞: ${ymToLabel(it.anchorYM||ymNow())}${it.endYM?(" ‚Ä¢ –∫—Ä–∞–π: "+ymToLabel(it.endYM)):""}`
        ));

        const right=document.createElement("div");
        right.style.display="flex";
        right.style.flexDirection="column";
        right.style.gap="8px";
        right.style.alignItems="flex-end";

        const cls = it.type==="income" ? "in" : it.type==="saving" ? "warn" : "out";
        const sign = it.type==="income" ? "+" : it.type==="expense" ? "‚àí" : "‚Üí";
        right.appendChild(el("div",`amt ${cls}`, `${sign} ${fmt.format(Number(it.amt)||0)}`));

        const del=el("button","danger","–ò–∑—Ç—Ä–∏–π");
        del.type="button";
        del.style.padding="8px 10px";
        del.style.borderRadius="10px";
        del.onclick=()=>{
          if(confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –ª–∏ —Ç–æ–∑–∏ recurring –∑–∞–ø–∏—Å?")){
            state.recurring = state.recurring.filter(x=>x.id!==it.id);
            persistSoon();
            render();
          }
        };
        right.appendChild(del);

        item.appendChild(meta);
        item.appendChild(right);
        recList.appendChild(item);
      }
    }

    function renderAutoDash(info){
      autoListDash.textContent="";
      const items=[];

      // credits (expense only)
      for(const c of info.credits){
        const pay = Number(c.pay)||0;
        if(c.mode !== "saving") items.push({kind:"–ö—Ä–µ–¥–∏—Ç", name:c.name, amt:pay});
      }

      // recurring expense only
      for(const r of (info.recurring||[])){
        if(r.type==="expense"){
          items.push({kind:"Recurring", name:r.name, amt:Number(r.amt)||0});
        }
      }

      if(!items.length){
        autoListDash.appendChild(el("div","small","–ù—è–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–∏—è."));
        autoHintDash.textContent="";
        return;
      }

      let total=0;
      for(const x of items){
        total+=x.amt;

        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", x.name));
        meta.appendChild(el("div","s", x.kind));
        item.appendChild(meta);
        item.appendChild(el("div","amt out","‚àí "+fmt.format(x.amt)));
        autoListDash.appendChild(item);
      }
      autoHintDash.textContent = "–û–±—â–æ: " + fmt.format(total);
    }

    function renderCreditsList(){
      creditList.textContent="";
      if(!state.credits.length){
        creditList.appendChild(el("div","small","–ù—è–º–∞ –∫—Ä–µ–¥–∏—Ç–∏."));
        return;
      }
      for(const c of state.credits){
        const endTxt = c.endYM ? ymToLabel(c.endYM) : "–±–µ–∑–∫—Ä–∞–µ–Ω";
        const item=el("div","item");

        const meta=el("div","meta");
        meta.appendChild(el("div","t", c.name));
        meta.appendChild(el("div","s",
          `–í–Ω–æ—Å–∫–∞: ${fmt.format(Number(c.pay)||0)} ‚Ä¢ ${ymToLabel(c.startYM)} ‚Üí ${endTxt} ‚Ä¢ —Ä–µ–∂–∏–º: ${c.mode==="saving"?"—Å–ø–µ—Å—Ç—è–≤–∞–Ω–µ":"—Ä–∞–∑—Ö–æ–¥"}`
        ));

        const actions=document.createElement("div");
        actions.style.display="flex";
        actions.style.flexDirection="column";
        actions.style.gap="8px";
        actions.style.minWidth="120px";

        const edit=el("button","secondary","–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π");
        edit.type="button";
        edit.onclick=()=>{
          editingCreditId=c.id;
          crName.value=c.name||"";
          crPay.value=c.pay ?? "";
          crStart.value=c.startYM||"";
          crEnd.value=c.endYM||"";
          crMode.value=c.mode||"expense";
          crNote.value=c.note||"";
          window.scrollTo({top:0, behavior:"smooth"});
        };

        const del=el("button","danger","–ò–∑—Ç—Ä–∏–π");
        del.type="button";
        del.onclick=()=>{
          if(confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –∫—Ä–µ–¥–∏—Ç–∞?")){
            state.credits = state.credits.filter(x=>x.id!==c.id);
            persistSoon();
            render();
          }
        };

        actions.appendChild(edit);
        actions.appendChild(del);

        item.appendChild(meta);
        item.appendChild(actions);
        creditList.appendChild(item);
      }
    }

    // =========================
    // Budgets UI
    // =========================
    function expenseCategoryNames(){
      return Object.keys(state.categories?.expense || {}).sort((a,b)=>a.localeCompare(b));
    }

    function fillBudgetDropdown(){
      budCat.innerHTML="";
      const cats = expenseCategoryNames();
      for(const c of cats){
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        budCat.appendChild(o);
      }
      if(cats.length) budCat.value=cats[0];
      const current = Number(state.budgets?.expense?.[budCat.value] || 0);
      budAmt.value = current ? current : "";
    }

    function renderBudgetList(){
      budList.textContent="";
      const obj = state.budgets?.expense || {};
      const entries = Object.entries(obj)
        .filter(([,v])=>Number(v)>0)
        .sort((a,b)=>a[0].localeCompare(b[0]));

      if(!entries.length){
        budList.appendChild(el("div","small","–ù—è–º–∞ –∑–∞–¥–∞–¥–µ–Ω–∏ –±—é–¥–∂–µ—Ç–∏."));
        return;
      }

      for(const [cat,amt] of entries){
        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", cat));
        meta.appendChild(el("div","s", "–ú–µ—Å–µ—á–µ–Ω –±—é–¥–∂–µ—Ç"));
        item.appendChild(meta);
        item.appendChild(el("div","amt warn", fmt.format(Number(amt)||0)));
        budList.appendChild(item);
      }
    }

    budCat.onchange=()=>{
      const current = Number(state.budgets?.expense?.[budCat.value] || 0);
      budAmt.value = current ? current : "";
    };

    btnSaveBudget.onclick=()=>{
      const cat = budCat.value;
      const amt = toMoney(budAmt.value);
      if(!cat) return;
      if(!Number.isFinite(amt) || amt<=0) return alert("–ë—é–¥–∂–µ—Ç—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –µ —á–∏—Å–ª–æ > 0.");

      if(!state.budgets) state.budgets = { expense:{} };
      if(!state.budgets.expense) state.budgets.expense = {};
      state.budgets.expense[cat] = amt;

      persistSoon();
      render();
      alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnDeleteBudget.onclick=()=>{
      const cat = budCat.value;
      if(!cat) return;

      if(state.budgets?.expense?.[cat] == null){
        budAmt.value="";
        return;
      }
      if(confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è –±—é–¥–∂–µ—Ç–∞ –∑–∞ "${cat}"?`)){
        delete state.budgets.expense[cat];
        persistSoon();
        render();
      }
    };

    // =========================
    // Charts (create once -> update)
    // =========================
    function ensureCatsChart(){
      if(chartCats) return;
      chartCats = new Chart(byId("chartCats"), {
        type:"doughnut",
        data:{ labels:[], datasets:[{ data:[] }] },
        options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{ position:"bottom" } } }
      });
    }
    function rebuildDashCharts(){
      const ymStr = state.settings.activeYM;
      const info = computeMonth(ymStr);
      const entries = Object.entries(info.expByCat).filter(([k,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const labels = entries.map(([k])=>k);
      const data = entries.map(([,v])=>v);
      ensureCatsChart();
      chartCats.data.labels = labels;
      chartCats.data.datasets[0].data = data;
      chartCats.update("none");
    }

    function rebuildReportsCharts(){
      const start24=addMonths(ymNow(), -23);
      const months24=[]; for(let i=0;i<24;i++) months24.push(addMonths(start24,i));
      let cum=Number(state.settings.startSavings)||0;
      const labelsCum=[], dataCum=[];
      for(const m of months24){
        const s = monthTx(m).filter(t=>t.type==="saving").reduce((acc,t)=>acc+(Number(t.amt)||0),0);
        cum += s;
        labelsCum.push(ymToLabel(m));
        dataCum.push(cum);
      }

      const start12=addMonths(ymNow(), -11);
      const months12=[]; for(let i=0;i<12;i++) months12.push(addMonths(start12,i));
      const labelsNet=months12.map(ymToLabel);
      const dataNet=months12.map(m=>computeMonth(m).net);

      if(!chartCum){
        chartCum = new Chart(byId("chartCum"), {
          type:"line",
          data:{ labels:labelsCum, datasets:[{ data:dataCum, tension:0.25 }]},
          options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:(v)=>fmt.format(v)} } } }
        });
      } else {
        chartCum.data.labels = labelsCum;
        chartCum.data.datasets[0].data = dataCum;
        chartCum.update("none");
      }

      if(!chartNet){
        chartNet = new Chart(byId("chartNet"), {
          type:"bar",
          data:{ labels:labelsNet, datasets:[{ data:dataNet }]},
          options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:(v)=>fmt.format(v)} } } }
        });
      } else {
        chartNet.data.labels = labelsNet;
        chartNet.data.datasets[0].data = dataNet;
        chartNet.update("none");
      }
    }

    function rebuildCarChart(){
      const start12=addMonths(ymNow(), -11);
      const months12=[]; for(let i=0;i<12;i++) months12.push(addMonths(start12,i));
      const labels=months12.map(ymToLabel);
      const data=months12.map(m=>computeCarMonth(m).total);

      if(!chartCar){
        chartCar = new Chart(byId("chartCar"), {
          type:"bar",
          data:{ labels, datasets:[{ data }]},
          options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:(v)=>fmt.format(v)} } } }
        });
      } else {
        chartCar.data.labels = labels;
        chartCar.data.datasets[0].data = data;
        chartCar.update("none");
      }
      renderCarMonth();
    }

    // =========================
    // Forecast
    // =========================
    function forecast12(){
      const start = addMonths(state.settings.activeYM || ymNow(), 1);
      const months = []; for(let i=0;i<12;i++) months.push(addMonths(start, i));

      const planInc = (Number(state.plan.salary)||0) + (Number(state.plan.vouchers)||0);
      const baseIncome = planInc>0 ? planInc : 0;

      const desiredSave = Number(state.settings.saveTarget)||0;

      const rows=[];
      for(const m of months){
        const rec = recurringForMonth(m);
        const recIncome = rec.filter(x=>x.type==="income").reduce((s,x)=>s+(Number(x.amt)||0),0);
        const recExpense = rec.filter(x=>x.type==="expense").reduce((s,x)=>s+(Number(x.amt)||0),0);
        const recSaving = rec.filter(x=>x.type==="saving").reduce((s,x)=>s+(Number(x.amt)||0),0);

        const cr=creditsForMonth(m);
        const creditExpense=cr.filter(c=>c.mode!=="saving").reduce((s,c)=>s+(Number(c.pay)||0),0);
        const creditSaving=cr.filter(c=>c.mode==="saving").reduce((s,c)=>s+(Number(c.pay)||0),0);

        const income = baseIncome + recIncome;
        const expense = recExpense + creditExpense;
        const savings = desiredSave + recSaving + creditSaving;
        const net = income - expense - savings;

        rows.push({m, income, expense, savings, net});
      }
      return rows;
    }

    function renderForecast(){
      forecastList.textContent="";
      const rows = forecast12();
      for(const r of rows){
        const item=el("div","item");
        const meta=el("div","meta");
        meta.appendChild(el("div","t", ymToLabel(r.m)));
        meta.appendChild(el("div","s", `–î–æ—Ö–æ–¥ ${fmt.format(r.income)} ‚Ä¢ –†–∞–∑—Ö–æ–¥–∏ ${fmt.format(r.expense)} ‚Ä¢ –°–ø–µ—Å—Ç. ${fmt.format(r.savings)}`));
        item.appendChild(meta);
        item.appendChild(el("div",`amt ${r.net<0?"out":"in"}`, `${r.net<0?"‚àí":"+"} ${fmt.format(Math.abs(r.net))}`));
        forecastList.appendChild(item);
      }
    }

    // =========================
    // Events
    // =========================
    selMonth.onchange=()=>{
      state.settings.activeYM=selMonth.value;
      persistSoon();
      render();
    };

    txType.onchange=fillTxCats;
    txCat.onchange=fillTxSubcats;

    btnClearTx.onclick=()=>{
      txAmt.value="";
      txNote.value="";
      txType.value="expense";
      fillTxCats();
    };

    btnAddTx.onclick=()=>{
      const date = txDate.value || new Date().toISOString().slice(0,10);
      const yms = ymFromDate(date);
      const type = txType.value;
      const cat = txCat.value;
      const subcat = txSubcat.value || "–î—Ä—É–≥–æ";
      const amt = toMoney(txAmt.value);

      if(!date || !yms) return alert("–ò–∑–±–µ—Ä–∏ –¥–∞—Ç–∞.");
      if(!cat || !Number.isFinite(amt) || amt<=0) return alert("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Å—É–º–∞ > 0.");

      const note = clampText((txNote.value||"").trim(), 200);

      state.tx.push({ id:uuid(), date, ym:yms, type, cat, subcat, amt, note });
      state.settings.activeYM = yms;

      txAmt.value=""; txNote.value="";
      persistSoon();
      setTab("dash");
      render();
    };

    quickSalary.onclick=()=>{
      txType.value="income";
      fillTxCats();
      txCat.value="–î–æ—Ö–æ–¥";
      fillTxSubcats();
      txSubcat.value="–ó–∞–ø–ª–∞—Ç–∞";
      setTab("add"); txAmt.focus();
    };
    quickVouchers.onclick=()=>{
      txType.value="income";
      fillTxCats();
      txCat.value="–î–æ—Ö–æ–¥";
      fillTxSubcats();
      txSubcat.value="–í–∞—É—á–µ—Ä–∏";
      setTab("add"); txAmt.focus();
    };
    quickFuel.onclick=()=>{
      txType.value="expense";
      fillTxCats();
      txCat.value="–ö–æ–ª–∞";
      fillTxSubcats();
      txSubcat.value="–ì–æ—Ä–∏–≤–æ";
      setTab("add"); txAmt.focus();
    };

    // Recurring events
    recType.onchange=fillRecCats;
    recCat.onchange=fillRecSubcats;

    btnAddRec.onclick=()=>{
      const name = clampText((recName.value||"").trim(), 60);
      const amt  = toMoney(recAmt.value);
      const type = recType.value;
      const cat  = recCat.value;
      const subcat = recSubcat.value || "–î—Ä—É–≥–æ";
      const every = recEvery.value;
      const anchorYM = recAnchor.value || ymNow();
      const endYM = recEnd.value || null;

      if(!name) return alert("–í—ä–≤–µ–¥–∏ –∏–º–µ.");
      if(!Number.isFinite(amt) || amt<=0) return alert("–°—É–º–∞ > 0.");
      if(endYM && endYM < anchorYM) return alert("–ö—Ä–∞–π–Ω–∏—è—Ç –º–µ—Å–µ—Ü –µ –ø—Ä–µ–¥–∏ –∫–æ—Ç–≤–∞—Ç–∞.");

      state.recurring.push({ id:uuid(), name, type, cat, subcat, amt, every, anchorYM, endYM });

      recName.value="";
      recAmt.value="";
      recEnd.value="";
      persistSoon();
      render();
    };

    // Credits events
    btnNewCredit.onclick=()=>{
      editingCreditId=null;
      crName.value=""; crPay.value="";
      crStart.value=ymNow(); crEnd.value="";
      crMode.value="expense"; crNote.value="";
    };

    btnSaveCredit.onclick=()=>{
      const name=clampText((crName.value||"").trim(), 40);
      const pay=toMoney(crPay.value);
      const startYM=crStart.value;
      const endYM=crEnd.value || null;
      const mode=crMode.value === "saving" ? "saving" : "expense";
      const note=clampText((crNote.value||"").trim(), 200);

      if(!name) return alert("–í—ä–≤–µ–¥–∏ –∏–º–µ.");
      if(!Number.isFinite(pay)||pay<=0) return alert("–í–Ω–æ—Å–∫–∞ > 0.");
      if(!startYM) return alert("–ù–∞—á–∞–ª–µ–Ω –º–µ—Å–µ—Ü.");
      if(endYM && endYM<startYM) return alert("–ö—Ä–∞–π–Ω–∏—è—Ç –º–µ—Å–µ—Ü –µ –ø—Ä–µ–¥–∏ –Ω–∞—á–∞–ª–Ω–∏—è.");

      if(editingCreditId){
        const c=state.credits.find(x=>x.id===editingCreditId);
        if(c){ c.name=name; c.pay=pay; c.startYM=startYM; c.endYM=endYM; c.mode=mode; c.note=note; }
      } else {
        state.credits.push({ id:uuid(), name, pay, startYM, endYM, mode, note });
      }

      editingCreditId=null;
      persistSoon();
      render();
      alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    // Plan / Settings events
    btnSavePlan.onclick=()=>{
      state.plan.salary = toMoney(planSalary.value);
      state.plan.vouchers = toMoney(planVouchers.value);
      persistSoon();
      render();
      alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnSaveSettings.onclick=()=>{
      state.settings.goal = toMoney(setGoal.value);
      state.settings.startSavings = toMoney(setStart.value);
      state.settings.saveTarget = toMoney(setSaveTarget.value);
      persistSoon();
      render();
      alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnSwitchProfile.onclick = showOverlay;
    btnLogout.onclick = ()=>{
      setActiveProfileId("");
      activeProfile=null;
      state=null;
      showOverlay();
    };

    // Export/Import active profile
    btnExportProfile.onclick=()=>{
      if(!activeProfile || !state) return;
      const payload = {
        version: "CashControl-profiles-v3",
        exportedAt: new Date().toISOString(),
        profile: {
          name: activeProfile.name,
          pinHash: activeProfile.pinHash || null,
          pinSalt: activeProfile.pinSalt || null
        },
        state
      };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      const safeName = activeProfile.name.replace(/[^\p{L}\p{N}_-]+/gu, "_");
      a.download=`cashcontrol-${safeName}-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    btnImportProfile.onclick=()=> importProfileFile.click();
    importProfileFile.onchange = async ()=>{
      const f = importProfileFile.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const parsed = JSON.parse(text);
        if(!parsed?.profile?.name || !parsed?.state) throw new Error("bad");

        const profiles = loadProfiles();
        const id = uuid();
        profiles.push({
          id,
          name: (parsed.profile.name || "–ò–º–ø–æ—Ä—Ç").trim(),
          pinHash: parsed.profile.pinHash || null,
          pinSalt: parsed.profile.pinSalt || null,
          createdAt: new Date().toISOString().slice(0,10),
          lastUsed: ""
        });
        saveProfiles(profiles);

        const migrated = sanitizeState(parsed.state);
        saveStateForProfile(id, migrated);

        await activateProfile(id);
        alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ ‚úÖ");
      }catch(e){
        alert("–ù–µ—É—Å–ø–µ—à–µ–Ω –∏–º–ø–æ—Ä—Ç. –£–≤–µ—Ä–∏ —Å–µ, —á–µ —Ñ–∞–π–ª—ä—Ç –µ Export –æ—Ç CashControl.");
      }finally{
        importProfileFile.value="";
      }
    };

    btnReset.onclick=()=>{
      if(!activeProfile?.id || !state) return;
      if(confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏? –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ –Ω–∞ —Ç–æ–∑–∏ –ø—Ä–æ—Ñ–∏–ª.")){
        state = defaultState();
        persist();
        render();
        alert("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
    };

    window.addEventListener("resize", ()=>{
      clearTimeout(window.__rz);
      window.__rz=setTimeout(()=>{
        if(!state) return;
        if(views.dash.style.display!=="none") rebuildDashCharts();
        if(views.reports.style.display!=="none") rebuildReportsCharts();
        if(views.car.style.display!=="none") rebuildCarChart();
      }, 150);
    });

    // =========================
    // Render
    // =========================
    function render(){
      if(!state || !activeProfile) return;

      ensureMonthOptions();
      const active = state.settings.activeYM;
      monthPill.textContent = ymToLabel(active);

      // Settings inputs
      setGoal.value = state.settings.goal ?? 0;
      setStart.value = state.settings.startSavings ?? 0;
      setSaveTarget.value = state.settings.saveTarget ?? 0;

      // Plan inputs
      planSalary.value = state.plan.salary ?? "";
      planVouchers.value = state.plan.vouchers ?? "";

      // Budget UI
      fillBudgetDropdown();
      renderBudgetList();

      // Dropdowns
      fillTxCats();
      fillRecCats();

      // KPI
      const info = computeMonth(active);

      kIncome.textContent = fmt.format(info.income);
      kExpense.textContent = fmt.format(info.expense);
      kSavings.textContent = fmt.format(info.savings);
      kNet.textContent = fmt.format(info.net);

      kIncomeNote.textContent = `–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${fmt.format(info.incomeTx)} ‚Ä¢ Recurring: ${fmt.format(info.recIncome)}`;
      kExpenseNote.textContent = `–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${fmt.format(info.expenseTx)} ‚Ä¢ –ö—Ä–µ–¥–∏—Ç–∏: ${fmt.format(info.creditExpense)} ‚Ä¢ Recurring: ${fmt.format(info.recExpense)}`;
      kNetNote.textContent = info.net < 0 ? "‚ö†Ô∏è –ü—Ä–µ—Ä–∞–∑—Ö–æ–¥" : "OK ‚úÖ";

      // Goal
      const goal = Number(state.settings.goal)||0;
      const now = totalSavings();
      kGoal.textContent = fmt.format(goal);
      kGoalNow.textContent = fmt.format(now);
      const pct = goal>0 ? Math.min(1, now/goal) : 0;
      goalBar.style.width = (pct*100).toFixed(1)+"%";
      goalProgressTxt.textContent = goal>0
        ? `–ü—Ä–æ–≥—Ä–µ—Å ${(pct*100).toFixed(1)}% ‚Ä¢ –û—Å—Ç–∞–≤–∞ ${fmt.format(Math.max(0, goal-now))}`
        : "–ó–∞–¥–∞–π —Ü–µ–ª.";

      // Dash extras
      renderAlerts(info);
      renderMoM(active);
      renderLeaks(active);
      renderBudgetProgress(info);

      // Lists
      renderTxList(active);
      renderTxManage(active);
      renderAutoDash(info);
      renderRecurring();
      renderCreditsList();
      renderCarMonth();
      renderForecast();

      // Charts
      if(views.dash.style.display!=="none") setTimeout(rebuildDashCharts, 40);
      if(views.car.style.display!=="none") setTimeout(rebuildCarChart, 40);

      persistSoon();
    }

    // init
    txDate.value = new Date().toISOString().slice(0,10);
    crStart.value = ymNow();
    recAnchor.value = ymNow();
    recEvery.value = "monthly";
    txType.value = "expense";
    ensureProfileOnStart();
  </script>
</body>
</html>
