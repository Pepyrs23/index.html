<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1220" />
  <title>–ë—é–¥–∂–µ—Ç ULTRA+</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --muted:#93a4c7; --text:#e7efff;
      --accent:#60a5fa; --good:#34d399; --bad:#fb7185; --warn:#fbbf24;
      --border:#223056; --input:#0f1b37;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#0b1220,#070c16);
      color:var(--text);
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 0 10px;gap:10px}
    h1{font-size:18px;margin:0;white-space:nowrap}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--border);border-radius:999px;white-space:nowrap}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{
      background:rgba(16,26,51,.88); border:1px solid var(--border);
      border-radius:16px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .value{font-size:18px;font-weight:900}
    .value.good{color:var(--good)}
    .value.bad{color:var(--bad)}
    .value.warn{color:var(--warn)}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    input, select, button, textarea{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      font-size:14px;
    }
    textarea{min-height:72px;resize:vertical}
    button{
      background:linear-gradient(180deg,#60a5fa,#3b82f6);
      border:none; font-weight:900;
    }
    button.secondary{
      background:transparent; border:1px solid var(--border); color:var(--text);
      font-weight:800;
    }
    button.danger{
      background:transparent; border:1px solid rgba(251,113,133,.55); color:var(--text);
      font-weight:900;
    }
    .tabs{display:flex;gap:8px;margin:10px 0 12px;flex-wrap:wrap}
    .tab{
      flex:1; min-width:120px;
      padding:10px 10px; border-radius:999px;
      border:1px solid var(--border); background:transparent; color:var(--muted);
      font-weight:900;
    }
    .tab.active{background:rgba(96,165,250,.15); color:var(--text); border-color:rgba(96,165,250,.4)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(12,22,49,.55)
    }
    .item .meta{min-width:0}
    .item .meta .t{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta .s{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.35}
    .amt{font-weight:1000;white-space:nowrap}
    .amt.in{color:var(--good)}
    .amt.out{color:var(--bad)}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .right{text-align:right}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(12,22,49,.55); color:var(--muted); font-size:12px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    canvas{width:100%;height:240px}
    .banner{
      border:1px solid rgba(251,191,36,.45);
      background:rgba(251,191,36,.08);
      padding:10px 12px;border-radius:14px;color:var(--text);
    }
    .banner.bad{
      border-color:rgba(251,113,133,.55);
      background:rgba(251,113,133,.08);
    }
  </style>
</head>
<body>
  <header>
    <h1>üì± –ë—é–¥–∂–µ—Ç ULTRA+</h1>
    <div class="pill" id="monthPill">‚Äî</div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tabDash">–¢–∞–±–ª–æ</button>
    <button class="tab" id="tabAdd">–î–æ–±–∞–≤–∏</button>
    <button class="tab" id="tabAuto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</button>
    <button class="tab" id="tabCredits">–ö—Ä–µ–¥–∏—Ç–∏</button>
    <button class="tab" id="tabCar">–ö–æ–ª–∞</button>
    <button class="tab" id="tabPlan">–ü–ª–∞–Ω</button>
    <button class="tab" id="tabReports">–û—Ç—á–µ—Ç–∏</button>
    <button class="tab" id="tabSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <!-- DASH -->
  <section id="viewDash" class="grid">
    <div class="card">
      <div class="label">–ú–µ—Å–µ—Ü</div>
      <select id="selMonth"></select>
      <div class="small" style="margin-top:6px">
        –°—É–º–∏—Ç–µ –≤–∫–ª—é—á–≤–∞—Ç: <b>—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</b> + <b>–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏</b> + <b>–∫—Ä–µ–¥–∏—Ç–∏</b>.
      </div>
    </div>

    <div id="alertBox" class="banner" style="display:none"></div>

    <div class="grid cards">
      <div class="card">
        <div class="label">–î–æ—Ö–æ–¥–∏</div>
        <div class="value" id="kIncome">‚Ç¨0</div>
        <div class="small" id="kIncomeNote">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–†–∞–∑—Ö–æ–¥–∏</div>
        <div class="value" id="kExpense">‚Ç¨0</div>
        <div class="small" id="kExpenseNote">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">–°–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è</div>
        <div class="value" id="kSavings">‚Ç¨0</div>
        <div class="small">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–∏–ø ‚Äû–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ‚Äú</div>
      </div>
      <div class="card">
        <div class="label">–ù–µ—Ç–Ω–æ</div>
        <div class="value" id="kNet">‚Ç¨0</div>
        <div class="small" id="kNetNote">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="label">–¶–µ–ª —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è</div>
          <div class="value" id="kGoal">‚Ç¨0</div>
        </div>
        <div class="right">
          <div class="label">–ù–∞—Ç—Ä—É–ø–∞–Ω–æ</div>
          <div class="value" id="kGoalNow">‚Ç¨0</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="small" id="goalProgressTxt">‚Äî</div>
      <div style="height:10px;background:#0b1430;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:8px">
        <div id="goalBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--good),var(--accent))"></div>
      </div>
      <div class="hr"></div>
      <div class="chips" id="autoChips"></div>
    </div>

    <div class="card">
      <div class="label">–†–∞–∑—Ö–æ–¥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü)</div>
      <canvas id="chartCats"></canvas>
      <div class="small" style="margin-top:8px">–í–∫–ª—é—á–≤–∞ –∏ –∞–≤—Ç–æ —Ä–∞–∑—Ö–æ–¥–∏/–∫—Ä–µ–¥–∏—Ç–∏.</div>
    </div>

    <div class="card">
      <div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü)</div>
      <div class="list" id="txList"></div>
    </div>

    <div class="card">
      <div class="label">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü)</div>
      <div class="list" id="autoListDash"></div>
      <div class="small" id="autoHintDash" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ADD -->
  <section id="viewAdd" class="grid" style="display:none">
    <div class="card">
      <div class="label">–î–æ–±–∞–≤–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (–º–µ—Å–µ—Ü—ä—Ç —Å–µ –≤–∑–∏–º–∞ –æ—Ç –¥–∞—Ç–∞—Ç–∞)</div>

      <div class="two">
        <input id="txDate" type="date" />
        <select id="txType">
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="expense">–†–∞–∑—Ö–æ–¥</option>
          <option value="saving">–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ</option>
        </select>
      </div>

      <div class="two" style="margin-top:10px">
        <select id="txCat"></select>
        <input id="txAmt" type="number" inputmode="decimal" placeholder="–°—É–º–∞ (EUR)" />
      </div>

      <textarea id="txNote" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)" style="margin-top:10px"></textarea>

      <div class="two" style="margin-top:10px">
        <button id="btnAddTx">–î–æ–±–∞–≤–∏</button>
        <button class="secondary" id="btnClearTx">–ò–∑—á–∏—Å—Ç–∏</button>
      </div>
    </div>

    <div class="card">
      <div class="label">–ë—ä—Ä–∑–∏ –±—É—Ç–æ–Ω–∏</div>
      <div class="three">
        <button class="secondary" id="quickSalary">+ –ó–∞–ø–ª–∞—Ç–∞</button>
        <button class="secondary" id="quickVouchers">+ –í–∞—É—á–µ—Ä–∏</button>
        <button class="secondary" id="quickFuel">‚àí –ì–æ—Ä–∏–≤–æ</button>
      </div>
      <div class="small" style="margin-top:8px">–ò–∑–±–∏—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ç–∞. –¢–∏ –≤—ä–≤–µ–∂–¥–∞—à –¥–∞—Ç–∞ –∏ —Å—É–º–∞.</div>
    </div>

    <div class="card">
      <div class="label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–æ–∑–∏ –º–µ—Å–µ—Ü) ‚Äì –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ</div>
      <div class="list" id="txListManage"></div>
    </div>
  </section>

  <!-- AUTO -->
  <section id="viewAuto" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏ (—Ñ–∏–∫—Å)</div>
      <div class="small">–ü–æ–ø—ä–ª–Ω–µ–Ω–æ –ø–æ —Ç–≤–æ—è –±—é–¥–∂–µ—Ç. + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ —Ü–µ–ª –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–µ.</div>
      <div class="hr"></div>

      <div class="two">
        <div>
          <div class="label">–ö–æ–º—É–Ω–∞–ª–Ω–∏</div>
          <input id="autoUtilities" type="number" inputmode="decimal" />
        </div>
        <div>
          <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
          <input id="autoPhone" type="number" inputmode="decimal" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <div class="label">Revolut Premium</div>
          <input id="autoRevolut" type="number" inputmode="decimal" />
        </div>
        <div>
          <div class="label">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ ‚Äì —Å—É–º–∞ (–Ω–∞ 3 –º–µ—Å–µ—Ü–∞)</div>
          <input id="autoInsuranceAmount" type="number" inputmode="decimal" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <div class="label">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ ‚Äì –∫–æ—Ç–≤–∞ –º–µ—Å–µ—Ü</div>
          <input id="autoInsuranceAnchor" type="month" />
        </div>
        <div>
          <div class="label">–õ–∏–º–∏—Ç —Ä–∞–∑—Ö–æ–¥–∏ (–∑–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)</div>
          <input id="limitSpending" type="number" inputmode="decimal" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <div class="label">–ü–ª–∞–Ω –ì–æ—Ä–∏–≤–æ</div>
          <input id="autoFuelPlan" type="number" inputmode="decimal" />
        </div>
        <div>
          <div class="label">–ü–ª–∞–Ω –•—Ä–∞–Ω–∞ (–∫–µ—à)</div>
          <input id="autoFoodPlan" type="number" inputmode="decimal" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <div class="label">–í–∫–ª—é—á–∏ –ø–ª–∞–Ω–æ–≤–µ—Ç–µ –∫–∞—Ç–æ –∞–≤—Ç–æ —Ä–∞–∑—Ö–æ–¥</div>
          <select id="autoIncludePlans">
            <option value="no">–ù–µ</option>
            <option value="yes">–î–∞</option>
          </select>
        </div>
        <div>
          <div class="label">–ñ–µ–ª–∞–Ω–æ –º–µ—Å–µ—á–Ω–æ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–µ (–∑–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞)</div>
          <input id="autoSaveTarget" type="number" inputmode="decimal" />
        </div>
      </div>

      <button style="margin-top:12px" id="btnSaveAuto">–ó–∞–ø–∞–∑–∏</button>
    </div>
  </section>

  <!-- CREDITS -->
  <section id="viewCredits" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ö—Ä–µ–¥–∏—Ç–∏ ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ</div>
      <div class="small">–ö—Ä–µ–¥–∏—Ç 1 –µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–∞ —Å–ø–∏—Ä–∞ –ø—Ä–µ–∑ –Æ–Ω–∏ 2026.</div>
      <div class="hr"></div>

      <input id="crName" placeholder="–ò–º–µ (–Ω–∞–ø—Ä. –ö—Ä–µ–¥–∏—Ç 1)" />
      <div class="two" style="margin-top:10px">
        <input id="crPay" type="number" inputmode="decimal" placeholder="–ú–µ—Å–µ—á–Ω–∞ –≤–Ω–æ—Å–∫–∞ (‚Ç¨)" />
        <select id="crMode">
          <option value="expense">–†–∞–∑—Ö–æ–¥</option>
          <option value="saving">–°–ø–µ—Å—Ç—è–≤–∞–Ω–µ</option>
        </select>
      </div>

      <div class="two" style="margin-top:10px">
        <input id="crStart" type="month" />
        <input id="crEnd" type="month" />
      </div>

      <textarea id="crNote" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)" style="margin-top:10px"></textarea>

      <div class="two" style="margin-top:10px">
        <button id="btnSaveCredit">–ó–∞–ø–∞–∑–∏ –∫—Ä–µ–¥–∏—Ç</button>
        <button class="secondary" id="btnNewCredit">–ù–æ–≤</button>
      </div>
    </div>

    <div class="card">
      <div class="label">–°–ø–∏—Å—ä–∫ –∫—Ä–µ–¥–∏—Ç–∏</div>
      <div class="list" id="creditList"></div>
    </div>
  </section>

  <!-- CAR -->
  <section id="viewCar" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ö–æ–ª–∞ ‚Äì –±—é–¥–∂–µ—Ç –∏ –ª–∏–º–∏—Ç–∏</div>
      <div class="hr"></div>
      <div class="two">
        <div>
          <div class="label">–õ–∏–º–∏—Ç –∫–æ–ª–∞ (–æ–±—â–æ)</div>
          <input id="carLimit" type="number" inputmode="decimal" />
        </div>
        <div>
          <div class="label">–õ–∏–º–∏—Ç –≥–æ—Ä–∏–≤–æ</div>
          <input id="carFuelLimit" type="number" inputmode="decimal" />
        </div>
      </div>
      <button style="margin-top:12px" id="btnSaveCar">–ó–∞–ø–∞–∑–∏</button>
    </div>

    <div class="card">
      <div class="label">–ì—Ä–∞—Ñ–∏–∫–∞: —Ä–∞–∑—Ö–æ–¥–∏ –∑–∞ –∫–æ–ª–∞ (12 –º–µ—Å–µ—Ü–∞)</div>
      <canvas id="chartCar"></canvas>
    </div>

    <div class="card">
      <div class="label">–¢–æ–∑–∏ –º–µ—Å–µ—Ü ‚Äì –∫–æ–ª–∞</div>
      <div class="list" id="carThisMonth"></div>
      <div class="small" id="carHint" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- PLAN -->
  <section id="viewPlan" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ü–ª–∞–Ω –¥–æ—Ö–æ–¥ + –ü—Ä–æ–≥–Ω–æ–∑–∞ (12 –º–µ—Å–µ—Ü–∞)</div>
      <div class="small">–ê–∫–æ –æ—Å—Ç–∞–≤–∏—à –ø—Ä–∞–∑–Ω–æ ‚Üí —â–µ –ø–æ–ª–∑–≤–∞ —Å—Ä–µ–¥–Ω–æ –æ—Ç —Ä–µ–∞–ª–Ω–∏ –¥–æ—Ö–æ–¥–∏.</div>
      <div class="hr"></div>
      <div class="two">
        <div>
          <div class="label">–ü–ª–∞–Ω –∑–∞–ø–ª–∞—Ç–∞ (‚Ç¨)</div>
          <input id="planSalary" type="number" inputmode="decimal" />
        </div>
        <div>
          <div class="label">–ü–ª–∞–Ω –≤–∞—É—á–µ—Ä–∏ (‚Ç¨)</div>
          <input id="planVouchers" type="number" inputmode="decimal" />
        </div>
      </div>
      <button style="margin-top:12px" id="btnSavePlan">–ó–∞–ø–∞–∑–∏ –ø–ª–∞–Ω</button>
    </div>

    <div class="card">
      <div class="label">–¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞</div>
      <div class="list" id="forecastList"></div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="viewReports" class="grid" style="display:none">
    <div class="card">
      <div class="label">–ù–∞—Ç—Ä—É–ø–∞–Ω–∏ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è (24 –º–µ—Å–µ—Ü–∞)</div>
      <canvas id="chartCum"></canvas>
    </div>

    <div class="card">
      <div class="label">–ù–µ—Ç–Ω–æ –ø–æ –º–µ—Å–µ—Ü–∏ (12 –º–µ—Å–µ—Ü–∞)</div>
      <canvas id="chartNet"></canvas>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="viewSettings" class="grid" style="display:none">
    <div class="card">
      <div class="label">–¶–µ–ª –∏ –Ω–∞—á–∞–ª–Ω–∏ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è</div>
      <div class="two">
        <input id="setGoal" type="number" inputmode="decimal" placeholder="–¶–µ–ª (‚Ç¨)" />
        <input id="setStart" type="number" inputmode="decimal" placeholder="–ù–∞—á–∞–ª–Ω–∏ —Å–ø–µ—Å—Ç—è–≤–∞–Ω–∏—è (‚Ç¨)" />
      </div>
      <button style="margin-top:10px" id="btnSaveSettings">–ó–∞–ø–∞–∑–∏</button>
    </div>

    <div class="card">
      <div class="label">Backup</div>
      <div class="two">
        <button class="secondary" id="btnExport">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="secondary" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <div class="hr"></div>
      <button class="danger" id="btnReset">–ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏</button>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const KEY = "budget_ultrap_v1";
    const monthNamesBG = ["–Ø–Ω—É–∞—Ä–∏","–§–µ–≤—Ä—É–∞—Ä–∏","–ú–∞—Ä—Ç","–ê–ø—Ä–∏–ª","–ú–∞–π","–Æ–Ω–∏","–Æ–ª–∏","–ê–≤–≥—É—Å—Ç","–°–µ–ø—Ç–µ–º–≤—Ä–∏","–û–∫—Ç–æ–º–≤—Ä–∏","–ù–æ–µ–º–≤—Ä–∏","–î–µ–∫–µ–º–≤—Ä–∏"];
    const fmt = new Intl.NumberFormat('bg-BG', { style:'currency', currency:'EUR' });

    const pad2 = (n)=>String(n).padStart(2,"0");
    const ymNow = ()=>{ const d=new Date(); return d.getFullYear()+"-"+pad2(d.getMonth()+1); };
    const ymFromDate = (dateStr)=> dateStr ? dateStr.slice(0,7) : "";
    const ymToLabel = (ymStr)=>{ const [y,m]=ymStr.split("-").map(Number); return monthNamesBG[m-1]+" "+y; };
    const addMonths = (ymStr, delta)=>{
      const [y,m]=ymStr.split("-").map(Number);
      const d=new Date(y, m-1, 1);
      d.setMonth(d.getMonth()+delta);
      return d.getFullYear()+"-"+pad2(d.getMonth()+1);
    };

    function load(){ try{ const raw=localStorage.getItem(KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    const nowYM = ymNow();
    const defaultState = {
      settings:{ activeYM: nowYM, goal: 10000, startSavings: 0 },
      plan:{ salary: 1350, vouchers: 100 },
      auto:{
        utilities: 60, phone: 55, revolut: 14,
        fuelPlan: 70, foodPlan: 60, includePlansAsAuto: "no",
        insuranceAmount: 35, insuranceAnchorYM: nowYM,
        spendingLimit: 0, autoSaveTarget: 0
      },
      car:{ limit: 200, fuelLimit: 100 },
      credits:[
        { id: crypto.randomUUID(), name:"–ö—Ä–µ–¥–∏—Ç 1 (–¥–æ —é–Ω–∏)", pay:125, startYM: nowYM, endYM:"2026-06", mode:"expense", note:"–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ –Æ–Ω–∏ 2026." },
        { id: crypto.randomUUID(), name:"–ö—Ä–µ–¥–∏—Ç 2", pay:150, startYM: nowYM, endYM:null, mode:"expense", note:"–î—ä–ª–≥–æ—Å—Ä–æ—á–µ–Ω." }
      ],
      tx:[]
    };
    let state = load() || structuredClone(defaultState);

    const cats = {
      income:["–ó–∞–ø–ª–∞—Ç–∞","–í–∞—É—á–µ—Ä–∏","–î—Ä—É–≥ –¥–æ—Ö–æ–¥"],
      expense:["–•—Ä–∞–Ω–∞ (–∫–µ—à)","–ì–æ—Ä–∏–≤–æ","–ö–æ–º—É–Ω–∞–ª–Ω–∏","–¢–µ–ª–µ—Ñ–æ–Ω","Revolut","–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞","–ü–æ–∫—É–ø–∫–∏","–ò–∑–ª–∏–∑–∞–Ω–µ","–ö–æ–ª–∞: –†–µ–º–æ–Ω—Ç–∏","–ö–æ–ª–∞: –¢–∞–∫—Å–∏","–ö–æ–ª–∞: –í–∏–Ω–µ—Ç–∫–∞/–ü–∞—Ä–∫–∏–Ω–≥","–î—Ä—É–≥–æ"],
      saving:["–ê–≤–∞—Ä–∏–π–Ω–∏","–ë—É—Ñ–µ—Ä","–î—ä–ª–≥–æ—Å—Ä–æ—á–Ω–∏"]
    };

    const byId = (id)=>document.getElementById(id);
    const tabs = {
      dash: byId("tabDash"), add: byId("tabAdd"), auto: byId("tabAuto"), credits: byId("tabCredits"),
      car: byId("tabCar"), plan: byId("tabPlan"), reports: byId("tabReports"), settings: byId("tabSettings")
    };
    const views = {
      dash: byId("viewDash"), add: byId("viewAdd"), auto: byId("viewAuto"), credits: byId("viewCredits"),
      car: byId("viewCar"), plan: byId("viewPlan"), reports: byId("viewReports"), settings: byId("viewSettings")
    };

    function setTab(activeKey){
      for(const k of Object.keys(tabs)){
        tabs[k].classList.toggle("active", k===activeKey);
        views[k].style.display = (k===activeKey) ? "grid" : "none";
      }
      if(activeKey==="reports") setTimeout(rebuildReportsCharts, 80);
      if(activeKey==="dash") setTimeout(rebuildDashCharts, 80);
      if(activeKey==="car") setTimeout(rebuildCarChart, 80);
    }
    tabs.dash.onclick=()=>setTab("dash");
    tabs.add.onclick=()=>setTab("add");
    tabs.auto.onclick=()=>setTab("auto");
    tabs.credits.onclick=()=>setTab("credits");
    tabs.car.onclick=()=>setTab("car");
    tabs.plan.onclick=()=>setTab("plan");
    tabs.reports.onclick=()=>setTab("reports");
    tabs.settings.onclick=()=>setTab("settings");

    const monthPill = byId("monthPill");
    const selMonth = byId("selMonth");
    const alertBox = byId("alertBox");

    const kIncome = byId("kIncome");
    const kExpense = byId("kExpense");
    const kSavings = byId("kSavings");
    const kNet = byId("kNet");
    const kIncomeNote = byId("kIncomeNote");
    const kExpenseNote = byId("kExpenseNote");
    const kNetNote = byId("kNetNote");

    const kGoal = byId("kGoal");
    const kGoalNow = byId("kGoalNow");
    const goalBar = byId("goalBar");
    const goalProgressTxt = byId("goalProgressTxt");
    const autoChips = byId("autoChips");

    const txList = byId("txList");
    const txListManage = byId("txListManage");

    const autoListDash = byId("autoListDash");
    const autoHintDash = byId("autoHintDash");

    const txDate = byId("txDate");
    const txType = byId("txType");
    const txCat = byId("txCat");
    const txAmt = byId("txAmt");
    const txNote = byId("txNote");
    const btnAddTx = byId("btnAddTx");
    const btnClearTx = byId("btnClearTx");
    const quickSalary = byId("quickSalary");
    const quickVouchers = byId("quickVouchers");
    const quickFuel = byId("quickFuel");

    const autoUtilities = byId("autoUtilities");
    const autoPhone = byId("autoPhone");
    const autoRevolut = byId("autoRevolut");
    const autoInsuranceAmount = byId("autoInsuranceAmount");
    const autoInsuranceAnchor = byId("autoInsuranceAnchor");
    const limitSpending = byId("limitSpending");
    const autoFuelPlan = byId("autoFuelPlan");
    const autoFoodPlan = byId("autoFoodPlan");
    const autoIncludePlans = byId("autoIncludePlans");
    const autoSaveTarget = byId("autoSaveTarget");

    const crName = byId("crName");
    const crPay = byId("crPay");
    const crStart = byId("crStart");
    const crEnd = byId("crEnd");
    const crMode = byId("crMode");
    const crNote = byId("crNote");
    const btnSaveCredit = byId("btnSaveCredit");
    const btnNewCredit = byId("btnNewCredit");
    const creditList = byId("creditList");
    let editingCreditId=null;

    const carLimit = byId("carLimit");
    const carFuelLimit = byId("carFuelLimit");
    const btnSaveCar = byId("btnSaveCar");
    const carThisMonth = byId("carThisMonth");
    const carHint = byId("carHint");

    const planSalary = byId("planSalary");
    const planVouchers = byId("planVouchers");
    const btnSavePlan = byId("btnSavePlan");
    const forecastList = byId("forecastList");

    const setGoal = byId("setGoal");
    const setStart = byId("setStart");
    const btnSaveSettings = byId("btnSaveSettings");
    const btnExport = byId("btnExport");
    const btnImport = byId("btnImport");
    const importFile = byId("importFile");
    const btnReset = byId("btnReset");

    let chartCum=null, chartNet=null, chartCats=null, chartCar=null;

    function fillCategorySelect(){
      txCat.innerHTML="";
      cats[txType.value].forEach(c=>{
        const o=document.createElement("option");
        o.value=c; o.textContent=c;
        txCat.appendChild(o);
      });
    }

    function ensureMonthOptions(){
      const opts=new Set();
      const start=addMonths(ymNow(), -23);
      for(let i=0;i<24;i++) opts.add(addMonths(start,i));
      for(const t of state.tx) if(t.ym) opts.add(t.ym);
      for(const c of state.credits){ if(c.startYM) opts.add(c.startYM); if(c.endYM) opts.add(c.endYM); }
      if(state.auto.insuranceAnchorYM) opts.add(state.auto.insuranceAnchorYM);

      const arr=Array.from(opts).sort((a,b)=>b.localeCompare(a));
      selMonth.innerHTML="";
      for(const v of arr){
        const o=document.createElement("option");
        o.value=v; o.textContent=ymToLabel(v);
        selMonth.appendChild(o);
      }
      if(!state.settings.activeYM || !arr.includes(state.settings.activeYM)) state.settings.activeYM=arr[0]||ymNow();
      selMonth.value=state.settings.activeYM;
    }

    function monthTx(ymStr){ return state.tx.filter(t=>t.ym===ymStr); }
    function inRange(startYM,endYM,ymStr){
      if(!startYM) return false;
      if(ymStr<startYM) return false;
      if(endYM && ymStr>endYM) return false;
      return true;
    }
    function creditsForMonth(ymStr){ return state.credits.filter(c=>inRange(c.startYM,c.endYM,ymStr)); }

    function insuranceDue(ymStr){
      const anchor = state.auto.insuranceAnchorYM || ymNow();
      const [ay,am]=anchor.split("-").map(Number);
      const [y,m]=ymStr.split("-").map(Number);
      const diff=(y-ay)*12+(m-am);
      return diff>=0 && diff%3===0;
    }

    function autoExpensesForMonth(ymStr){
      const a=state.auto;
      const list=[];
      if(Number(a.utilities)>0) list.push({name:"–ö–æ–º—É–Ω–∞–ª–Ω–∏", amt:Number(a.utilities), cat:"–ö–æ–º—É–Ω–∞–ª–Ω–∏"});
      if(Number(a.phone)>0) list.push({name:"–¢–µ–ª–µ—Ñ–æ–Ω", amt:Number(a.phone), cat:"–¢–µ–ª–µ—Ñ–æ–Ω"});
      if(Number(a.revolut)>0) list.push({name:"Revolut Premium", amt:Number(a.revolut), cat:"Revolut"});
      if(Number(a.insuranceAmount)>0 && insuranceDue(ymStr)) list.push({name:"–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ (3–º)", amt:Number(a.insuranceAmount), cat:"–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞"});
      if(a.includePlansAsAuto==="yes"){
        if(Number(a.fuelPlan)>0) list.push({name:"–ì–æ—Ä–∏–≤–æ (–ø–ª–∞–Ω)", amt:Number(a.fuelPlan), cat:"–ì–æ—Ä–∏–≤–æ"});
        if(Number(a.foodPlan)>0) list.push({name:"–•—Ä–∞–Ω–∞ (–ø–ª–∞–Ω)", amt:Number(a.foodPlan), cat:"–•—Ä–∞–Ω–∞ (–∫–µ—à)"});
      }
      return list;
    }

    function computeMonth(ymStr){
      const tx=monthTx(ymStr);
      let incomeTx=0, expenseTx=0, savingTx=0;
      const expByCat = {};
      const addExpCat = (cat, amt)=>{ expByCat[cat]=(expByCat[cat]||0)+amt; };

      for(const t of tx){
        const a=Number(t.amt)||0;
        if(t.type==="income") incomeTx+=a;
        else if(t.type==="expense"){ expenseTx+=a; addExpCat(t.cat, a); }
        else if(t.type==="saving") savingTx+=a;
      }

      const cr=creditsForMonth(ymStr);
      let creditExpense=0;
      for(const c of cr){
        const p=Number(c.pay)||0;
        if(c.mode!=="saving"){ creditExpense+=p; addExpCat("–ö—Ä–µ–¥–∏—Ç–∏", p); }
      }

      const auto=autoExpensesForMonth(ymStr);
      const autoExpense=auto.reduce((s,x)=>s+(Number(x.amt)||0),0);
      for(const a of auto) addExpCat(a.cat, Number(a.amt)||0);

      const income=incomeTx;
      const expense=expenseTx+creditExpense+autoExpense;
      const savings=savingTx;
      const net=income-expense-savings;

      return {income,expense,savings,net,incomeTx,expenseTx,savingTx,creditExpense,autoExpense,autoList:auto,credits:cr,expByCat};
    }

    function totalSavings(){
      let s=Number(state.settings.startSavings)||0;
      for(const t of state.tx) if(t.type==="saving") s+=Number(t.amt)||0;
      return s;
    }

    function computeCarMonth(ymStr){
      const tx = monthTx(ymStr).filter(t=>t.type==="expense");
      const isCarCat = (c)=>["–ì–æ—Ä–∏–≤–æ","–ö–æ–ª–∞: –†–µ–º–æ–Ω—Ç–∏","–ö–æ–ª–∞: –¢–∞–∫—Å–∏","–ö–æ–ª–∞: –í–∏–Ω–µ—Ç–∫–∞/–ü–∞—Ä–∫–∏–Ω–≥"].includes(c);
      const items = tx.filter(t=>isCarCat(t.cat));
      const by = {};
      for(const t of items) by[t.cat]=(by[t.cat]||0)+(Number(t.amt)||0);
      const total = Object.values(by).reduce((a,b)=>a+b,0);
      return {by,total};
    }

    function renderCarMonth(){
      const ymStr = state.settings.activeYM;
      const {by,total} = computeCarMonth(ymStr);
      carThisMonth.innerHTML="";
      if(!total){
        carThisMonth.innerHTML = `<div class="small">–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏ –∑–∞ –∫–æ–ª–∞ —Ç–æ–∑–∏ –º–µ—Å–µ—Ü.</div>`;
        carHint.textContent = "";
        return;
      }
      for(const [cat,amt] of Object.entries(by)){
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="meta"><div class="t">${cat}</div><div class="s">–¢–æ–∑–∏ –º–µ—Å–µ—Ü</div></div>
          <div class="amt out">‚àí ${fmt.format(amt)}</div>`;
        carThisMonth.appendChild(div);
      }
      const limit = Number(state.car.limit)||0;
      carHint.textContent = `–û–±—â–æ: ${fmt.format(total)} ‚Ä¢ –õ–∏–º–∏—Ç: ${fmt.format(limit)} ‚Ä¢ –û—Å—Ç–∞–≤–∞: ${fmt.format(Math.max(0,limit-total))}`;
    }

    function renderAutoChips(){
      autoChips.innerHTML="";
      const a=state.auto;
      const chips=[
        ["–ö–æ–º—É–Ω–∞–ª–Ω–∏", fmt.format(Number(a.utilities)||0)],
        ["–¢–µ–ª–µ—Ñ–æ–Ω", fmt.format(Number(a.phone)||0)],
        ["Revolut", fmt.format(Number(a.revolut)||0)],
        ["–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞/3–º", fmt.format(Number(a.insuranceAmount)||0)+" ‚Ä¢ "+(a.insuranceAnchorYM?ymToLabel(a.insuranceAnchorYM):"‚Äî")]
      ];
      chips.forEach(([t,v])=>{
        const s=document.createElement("span");
        s.className="chip";
        s.textContent=t+": "+v;
        autoChips.appendChild(s);
      });
    }

    function renderAlerts(info){
      alertBox.style.display="none";
      alertBox.classList.remove("bad");
      const msgs=[];
      if(info.net<0){ msgs.push("‚ö†Ô∏è –ü—Ä–µ—Ä–∞–∑—Ö–æ–¥ (–Ω–µ—Ç–Ω–æ—Ç–æ –µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–Ω–æ)."); alertBox.classList.add("bad"); }
      const lim=Number(state.auto.spendingLimit)||0;
      if(lim>0 && info.expense>lim) msgs.push(`‚ö†Ô∏è –†–∞–∑—Ö–æ–¥–∏ ${fmt.format(info.expense)} –Ω–∞–¥ –ª–∏–º–∏—Ç–∞ ${fmt.format(lim)}.`);
      const carSpend = computeCarMonth(state.settings.activeYM).total;
      if(Number(state.car.limit)>0 && carSpend>Number(state.car.limit)) msgs.push(`‚ö†Ô∏è –ö–æ–ª–∞ ${fmt.format(carSpend)} –Ω–∞–¥ –ª–∏–º–∏—Ç ${fmt.format(Number(state.car.limit))}.`);
      if(msgs.length){
        alertBox.style.display="block";
        alertBox.innerHTML = "<b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</b><br/>" + msgs.map(m=>"‚Ä¢ "+m).join("<br/>");
      }
    }

    function renderTxList(ymStr){
      const arr=monthTx(ymStr).slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));
      txList.innerHTML="";
      const last=arr.slice(0,12);
      if(!last.length){ txList.innerHTML='<div class="small">–ù—è–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –û—Ç–∏–¥–∏ –Ω–∞ ‚Äú–î–æ–±–∞–≤–∏‚Äù.</div>'; return; }
      for(const t of last){
        const div=document.createElement("div");
        div.className="item";
        const prefix=t.type==="income"?"+":(t.type==="expense"?"‚àí":"‚Üí");
        const cls=t.type==="income"?"in":(t.type==="expense"?"out":"");
        div.innerHTML = `
          <div class="meta"><div class="t">${t.cat}</div><div class="s">${t.date||""}${t.note?(" ‚Ä¢ "+t.note):""}</div></div>
          <div class="amt ${cls}">${prefix} ${fmt.format(Number(t.amt)||0)}</div>`;
        txList.appendChild(div);
      }
    }

    function renderTxManage(ymStr){
      const arr=monthTx(ymStr).slice().sort((a,b)=>(b.date||"").localeCompare(a.date||""));
      txListManage.innerHTML="";
      if(!arr.length){ txListManage.innerHTML='<div class="small">–ù—è–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ —Ç–æ–∑–∏ –º–µ—Å–µ—Ü.</div>'; return; }
      for(const t of arr.slice(0,40)){
        const div=document.createElement("div");
        div.className="item";
        const prefix=t.type==="income"?"+":(t.type==="expense"?"‚àí":"‚Üí");
        const cls=t.type==="income"?"in":(t.type==="expense"?"out":"");
        div.innerHTML = `
          <div class="meta"><div class="t">${t.cat}</div><div class="s">${t.date||""}${t.note?(" ‚Ä¢ "+t.note):""}</div></div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <div class="amt ${cls}">${prefix} ${fmt.format(Number(t.amt)||0)}</div>
            <button class="danger" data-id="${t.id}" style="padding:8px 10px;border-radius:10px">–ò–∑—Ç—Ä–∏–π</button>
          </div>`;
        txListManage.appendChild(div);
      }
      txListManage.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-id");
          if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ç–∞?")){
            state.tx = state.tx.filter(x=>x.id!==id);
            save(); render();
          }
        };
      });
    }

    function renderAutoDash(info){
      autoListDash.innerHTML="";
      const items=[];
      for(const c of info.credits) items.push({kind:"–ö—Ä–µ–¥–∏—Ç", name:c.name, amt:Number(c.pay)||0});
      for(const a of info.autoList) items.push({kind:"–ê–≤—Ç–æ", name:a.name, amt:Number(a.amt)||0});
      if(!items.length){ autoListDash.innerHTML='<div class="small">–ù—è–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–∏—è.</div>'; autoHintDash.textContent=""; return; }
      let total=0;
      for(const x of items){
        total+=x.amt;
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="meta"><div class="t">${x.name}</div><div class="s">${x.kind}</div></div>
          <div class="amt out">‚àí ${fmt.format(x.amt)}</div>`;
        autoListDash.appendChild(div);
      }
      autoHintDash.textContent = "–û–±—â–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ: "+fmt.format(total);
    }

    function renderCreditsList(){
      creditList.innerHTML="";
      if(!state.credits.length){ creditList.innerHTML='<div class="small">–ù—è–º–∞ –∫—Ä–µ–¥–∏—Ç–∏.</div>'; return; }
      for(const c of state.credits){
        const endTxt = c.endYM ? ymToLabel(c.endYM) : "–±–µ–∑–∫—Ä–∞–µ–Ω";
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="meta"><div class="t">${c.name}</div><div class="s">–í–Ω–æ—Å–∫–∞: <b>${fmt.format(Number(c.pay)||0)}</b> ‚Ä¢ ${ymToLabel(c.startYM)} ‚Üí ${endTxt}</div></div>
          <div style="display:flex;flex-direction:column;gap:8px;min-width:120px">
            <button class="secondary" data-act="edit" data-id="${c.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
            <button class="danger" data-act="del" data-id="${c.id}">–ò–∑—Ç—Ä–∏–π</button>
          </div>`;
        creditList.appendChild(div);
      }
      creditList.querySelectorAll("button").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-id");
          const act=btn.getAttribute("data-act");
          if(act==="del"){
            if(confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –∫—Ä–µ–¥–∏—Ç–∞?")){
              state.credits = state.credits.filter(x=>x.id!==id);
              save(); render();
            }
            return;
          }
          if(act==="edit"){
            const c=state.credits.find(x=>x.id===id);
            if(!c) return;
            editingCreditId=id;
            crName.value=c.name||""; crPay.value=c.pay ?? ""; crStart.value=c.startYM||""; crEnd.value=c.endYM||"";
            crMode.value=c.mode||"expense"; crNote.value=c.note||"";
            window.scrollTo({top:0, behavior:"smooth"});
          }
        };
      });
    }

    function rebuildDashCharts(){
      const ymStr = state.settings.activeYM;
      const info = computeMonth(ymStr);
      const entries = Object.entries(info.expByCat).filter(([k,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,8);
      const labels = entries.map(([k])=>k);
      const data = entries.map(([,v])=>v);
      if(chartCats) chartCats.destroy();
      chartCats = new Chart(byId("chartCats"), { type:"doughnut", data:{ labels, datasets:[{ data }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } } });
    }

    function rebuildReportsCharts(){
      const start24=addMonths(ymNow(), -23);
      const months24=[]; for(let i=0;i<24;i++) months24.push(addMonths(start24,i));
      let cum=Number(state.settings.startSavings)||0;
      const labelsCum=[], dataCum=[];
      for(const m of months24){
        const s = monthTx(m).filter(t=>t.type==="saving").reduce((acc,t)=>acc+(Number(t.amt)||0),0);
        cum += s; labelsCum.push(ymToLabel(m)); dataCum.push(cum);
      }
      const start12=addMonths(ymNow(), -11);
      const months12=[]; for(let i=0;i<12;i++) months12.push(addMonths(start12,i));
      const labelsNet=months12.map(ymToLabel);
      const dataNet=months12.map(m=>computeMonth(m).net);

      if(chartCum) chartCum.destroy();
      if(chartNet) chartNet.destroy();

      chartCum = new Chart(byId("chartCum"), { type:"line", data:{ labels:labelsCum, datasets:[{ data:dataCum, tension:0.25 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:(v)=>fmt.format(v)} } } }});
      chartNet = new Chart(byId("chartNet"), { type:"bar", data:{ labels:labelsNet, datasets:[{ data:dataNet }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:(v)=>fmt.format(v)} } } }});
    }

    function rebuildCarChart(){
      const start12=addMonths(ymNow(), -11);
      const months12=[]; for(let i=0;i<12;i++) months12.push(addMonths(start12,i));
      const labels=months12.map(ymToLabel);
      const data=months12.map(m=>computeCarMonth(m).total);
      if(chartCar) chartCar.destroy();
      chartCar = new Chart(byId("chartCar"), { type:"bar", data:{ labels, datasets:[{ data }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:(v)=>fmt.format(v)} } } }});
      renderCarMonth();
    }

    function forecast12(){
      const start = addMonths(state.settings.activeYM || ymNow(), 1);
      const months = []; for(let i=0;i<12;i++) months.push(addMonths(start, i));
      const planInc = (Number(state.plan.salary)||0) + (Number(state.plan.vouchers)||0);
      const baseIncome = planInc>0 ? planInc : 0;
      const desiredSave = Number(state.auto.autoSaveTarget)||0;

      const rows=[];
      for(const m of months){
        const auto=autoExpensesForMonth(m);
        const autoExpense=auto.reduce((s,x)=>s+(Number(x.amt)||0),0);
        const cr=creditsForMonth(m);
        const creditExpense=cr.filter(c=>c.mode!=="saving").reduce((s,c)=>s+(Number(c.pay)||0),0);
        const expense = autoExpense + creditExpense;
        const savings = desiredSave;
        const net = baseIncome - expense - savings;
        rows.push({m, income:baseIncome, expense, savings, net});
      }
      return rows;
    }

    function renderForecast(){
      forecastList.innerHTML="";
      const rows = forecast12();
      for(const r of rows){
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="meta"><div class="t">${ymToLabel(r.m)}</div><div class="s">–î–æ—Ö–æ–¥ ${fmt.format(r.income)} ‚Ä¢ –†–∞–∑—Ö–æ–¥–∏ ${fmt.format(r.expense)} ‚Ä¢ –°–ø–µ—Å—Ç. ${fmt.format(r.savings)}</div></div>
          <div class="amt ${r.net<0?"out":"in"}">${r.net<0?"‚àí":"+"} ${fmt.format(Math.abs(r.net))}</div>`;
        forecastList.appendChild(div);
      }
    }

    function render(){
      ensureMonthOptions();
      const active=state.settings.activeYM;
      monthPill.textContent=ymToLabel(active);

      setGoal.value = state.settings.goal ?? 10000;
      setStart.value = state.settings.startSavings ?? 0;

      autoUtilities.value = state.auto.utilities ?? 0;
      autoPhone.value = state.auto.phone ?? 0;
      autoRevolut.value = state.auto.revolut ?? 0;
      autoInsuranceAmount.value = state.auto.insuranceAmount ?? 0;
      autoInsuranceAnchor.value = state.auto.insuranceAnchorYM || ymNow();
      limitSpending.value = state.auto.spendingLimit ?? 0;
      autoFuelPlan.value = state.auto.fuelPlan ?? 0;
      autoFoodPlan.value = state.auto.foodPlan ?? 0;
      autoIncludePlans.value = state.auto.includePlansAsAuto || "no";
      autoSaveTarget.value = state.auto.autoSaveTarget ?? 0;

      carLimit.value = state.car.limit ?? 0;
      carFuelLimit.value = state.car.fuelLimit ?? 0;

      planSalary.value = state.plan.salary ?? "";
      planVouchers.value = state.plan.vouchers ?? "";

      const info=computeMonth(active);
      kIncome.textContent=fmt.format(info.income);
      kExpense.textContent=fmt.format(info.expense);
      kSavings.textContent=fmt.format(info.savings);
      kNet.textContent=fmt.format(info.net);

      kIncomeNote.textContent="–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: "+fmt.format(info.incomeTx);
      kExpenseNote.textContent="–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: "+fmt.format(info.expenseTx)+" ‚Ä¢ –ö—Ä–µ–¥–∏—Ç–∏: "+fmt.format(info.creditExpense)+" ‚Ä¢ –ê–≤—Ç–æ: "+fmt.format(info.autoExpense);
      kNetNote.textContent = info.net<0 ? "‚ö†Ô∏è –ü—Ä–µ—Ä–∞–∑—Ö–æ–¥" : "OK ‚úÖ";

      const goal=Number(state.settings.goal)||0;
      const now=totalSavings();
      kGoal.textContent=fmt.format(goal);
      kGoalNow.textContent=fmt.format(now);
      const pct = goal>0 ? Math.min(1, now/goal) : 0;
      goalBar.style.width=(pct*100).toFixed(1)+"%";
      goalProgressTxt.textContent = goal>0 ? `–ü—Ä–æ–≥—Ä–µ—Å ${(pct*100).toFixed(1)}% ‚Ä¢ –û—Å—Ç–∞–≤–∞ ${fmt.format(Math.max(0, goal-now))}` : "–ó–∞–¥–∞–π —Ü–µ–ª.";

      renderAutoChips();
      renderAlerts(info);
      renderTxList(active);
      renderTxManage(active);
      renderAutoDash(info);
      renderCreditsList();
      renderCarMonth();
      renderForecast();

      if(views.dash.style.display!=="none") setTimeout(rebuildDashCharts, 60);

      save();
    }

    // events
    selMonth.onchange=()=>{ state.settings.activeYM=selMonth.value; save(); render(); };

    txType.onchange=fillCategorySelect;
    btnClearTx.onclick=()=>{ txAmt.value=""; txNote.value=""; txType.value="expense"; fillCategorySelect(); };

    btnAddTx.onclick=()=>{
      const date = txDate.value || new Date().toISOString().slice(0,10);
      const yms = ymFromDate(date);
      const type = txType.value;
      const cat = txCat.value;
      const amt = Number(txAmt.value);
      if(!date || !yms){ alert("–ò–∑–±–µ—Ä–∏ –¥–∞—Ç–∞."); return; }
      if(!cat || !Number.isFinite(amt) || amt<=0){ alert("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Å—É–º–∞ > 0."); return; }
      const note=(txNote.value||"").trim();
      state.tx.push({ id:crypto.randomUUID(), date, ym:yms, type, cat, amt, note });
      state.settings.activeYM=yms;
      txAmt.value=""; txNote.value="";
      save(); setTab("dash"); render();
    };

    quickSalary.onclick=()=>{ txType.value="income"; fillCategorySelect(); txCat.value="–ó–∞–ø–ª–∞—Ç–∞"; setTab("add"); txAmt.focus(); };
    quickVouchers.onclick=()=>{ txType.value="income"; fillCategorySelect(); txCat.value="–í–∞—É—á–µ—Ä–∏"; setTab("add"); txAmt.focus(); };
    quickFuel.onclick=()=>{ txType.value="expense"; fillCategorySelect(); txCat.value="–ì–æ—Ä–∏–≤–æ"; setTab("add"); txAmt.focus(); };

    byId("btnSaveAuto").onclick=()=>{
      state.auto.utilities = Number(autoUtilities.value)||0;
      state.auto.phone = Number(autoPhone.value)||0;
      state.auto.revolut = Number(autoRevolut.value)||0;
      state.auto.insuranceAmount = Number(autoInsuranceAmount.value)||0;
      state.auto.insuranceAnchorYM = autoInsuranceAnchor.value || ymNow();
      state.auto.spendingLimit = Number(limitSpending.value)||0;
      state.auto.fuelPlan = Number(autoFuelPlan.value)||0;
      state.auto.foodPlan = Number(autoFoodPlan.value)||0;
      state.auto.includePlansAsAuto = autoIncludePlans.value || "no";
      state.auto.autoSaveTarget = Number(autoSaveTarget.value)||0;
      save(); render(); alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnSaveCar.onclick=()=>{
      state.car.limit = Number(carLimit.value)||0;
      state.car.fuelLimit = Number(carFuelLimit.value)||0;
      save(); render(); alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnNewCredit.onclick=()=>{
      editingCreditId=null;
      crName.value=""; crPay.value=""; crStart.value=ymNow(); crEnd.value="";
      crMode.value="expense"; crNote.value="";
    };

    btnSaveCredit.onclick=()=>{
      const name=(crName.value||"").trim();
      const pay=Number(crPay.value);
      const startYM=crStart.value;
      const endYM=crEnd.value || null;
      const mode=crMode.value;
      const note=(crNote.value||"").trim();

      if(!name){ alert("–í—ä–≤–µ–¥–∏ –∏–º–µ."); return; }
      if(!Number.isFinite(pay)||pay<=0){ alert("–í–Ω–æ—Å–∫–∞ > 0."); return; }
      if(!startYM){ alert("–ù–∞—á–∞–ª–µ–Ω –º–µ—Å–µ—Ü."); return; }
      if(endYM && endYM<startYM){ alert("–ö—Ä–∞–π–Ω–∏—è—Ç –º–µ—Å–µ—Ü –µ –ø—Ä–µ–¥–∏ –Ω–∞—á–∞–ª–Ω–∏—è."); return; }

      if(editingCreditId){
        const c=state.credits.find(x=>x.id===editingCreditId);
        if(c){ c.name=name; c.pay=pay; c.startYM=startYM; c.endYM=endYM; c.mode=mode; c.note=note; }
      } else {
        state.credits.push({ id:crypto.randomUUID(), name, pay, startYM, endYM, mode, note });
      }
      editingCreditId=null;
      save(); render(); alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnSavePlan.onclick=()=>{
      state.plan.salary = planSalary.value==="" ? 0 : Number(planSalary.value);
      state.plan.vouchers = planVouchers.value==="" ? 0 : Number(planVouchers.value);
      save(); render(); alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnSaveSettings.onclick=()=>{
      state.settings.goal = Number(setGoal.value)||0;
      state.settings.startSavings = Number(setStart.value)||0;
      save(); render(); alert("–ó–∞–ø–∞–∑–µ–Ω–æ ‚úÖ");
    };

    btnExport.onclick=()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="budget-ultrap-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    btnImport.onclick=()=>importFile.click();
    importFile.onchange=async ()=>{
      const f=importFile.files?.[0];
      if(!f) return;
      try{
        const text=await f.text();
        const parsed=JSON.parse(text);
        if(!parsed || !parsed.settings || !parsed.auto || !Array.isArray(parsed.tx) || !Array.isArray(parsed.credits)) throw new Error("bad");
        state=parsed;
        save(); render(); alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ ‚úÖ");
      }catch(e){ alert("–ù–µ—É—Å–ø–µ—à–µ–Ω –∏–º–ø–æ—Ä—Ç."); }
      finally{ importFile.value=""; }
    };

    btnReset.onclick=()=>{
      if(confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏? –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏.")){
        state = structuredClone(defaultState);
        save(); render(); alert("–ò–∑—Ç—Ä–∏—Ç–æ.");
      }
    };

    window.addEventListener("resize", ()=>{
      clearTimeout(window.__rz);
      window.__rz=setTimeout(()=>{
        if(views.dash.style.display!=="none") rebuildDashCharts();
        if(views.reports.style.display!=="none") rebuildReportsCharts();
        if(views.car.style.display!=="none") rebuildCarChart();
      }, 150);
    });

    // init
    txType.value="expense";
    fillCategorySelect();
    txDate.value=new Date().toISOString().slice(0,10);
    crStart.value=ymNow();
    render();
  </script>
</body>
</html>
