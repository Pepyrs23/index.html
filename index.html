<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b1220">
<title>CashControl</title>

<style>
  :root{
    --bg:#0b1220; --card:#101a33; --muted:#93a4c7; --text:#e7efff;
    --accent:#3b82f6; --border:#223056; --input:#0f1b37;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    background:var(--bg);
    color:var(--text);
    padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
  }
  h1{margin:0 0 8px 0;font-size:20px}
  h2{margin:0 0 10px 0;font-size:18px}
  .small{color:var(--muted);font-size:12px;line-height:1.35}
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
    margin-bottom:14px;
  }
  .row{display:flex;gap:10px;align-items:center}
  .row > *{flex:1}
  button{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:none;
    background:var(--accent);
    color:white;
    font-weight:800;
    margin-top:8px;
  }
  button.secondary{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
  }
  button.danger{
    background:transparent;
    border:1px solid rgba(251,113,133,.6);
    color:var(--text);
  }
  input,select{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--input);
    color:var(--text);
    margin-top:8px;
    font-size:14px;
  }
  .tabs{display:flex;gap:8px;margin:12px 0}
  .tab{
    flex:1;padding:10px;border-radius:999px;border:1px solid var(--border);
    background:transparent;color:var(--muted);font-weight:800
  }
  .tab.active{background:rgba(59,130,246,.25);color:var(--text);border-color:rgba(59,130,246,.6)}
  .item{
    display:flex;justify-content:space-between;gap:10px;align-items:center;
    padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(12,22,49,.55);
    margin-top:10px;
  }
  .item b{white-space:nowrap}
  .chartBox{height:260px;position:relative}
  .chartBox canvas{width:100%!important;height:100%!important;display:block}

  .overlay{
    position:fixed; inset:0;
    background:linear-gradient(180deg,rgba(11,18,32,.98),rgba(7,12,22,.98));
    padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    overflow:auto;
    display:none;
    z-index:9999;
  }
</style>
</head>
<body>

<!-- PROFILE OVERLAY -->
<div class="overlay" id="overlay">
  <h2>üë§ CashControl –ø—Ä–æ—Ñ–∏–ª–∏</h2>
  <div class="small">–ü—Ä–æ—Ñ–∏–ª–∏—Ç–µ —Å–∞ –ª–æ–∫–∞–ª–Ω–∏ ‚Äì –≤—Å–µ–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–∞–∑–∏ —Å–≤–æ–∏—Ç–µ –¥–∞–Ω–Ω–∏. Export/Import –µ –∑–∞ —Å–º—è–Ω–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω.</div>

  <div class="card" style="margin-top:12px">
    <div id="profileList"></div>
    <button class="secondary" onclick="showCreate()">+ –ù–æ–≤ –ø—Ä–æ—Ñ–∏–ª</button>
  </div>

  <div class="card" id="createCard" style="display:none">
    <div class="small">–°—ä–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª</div>
    <input id="newName" placeholder="–ò–º–µ (–Ω–∞–ø—Ä. –ò–≤–∞–Ω)">
    <input id="newPin" type="password" inputmode="numeric" placeholder="PIN (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)">
    <div class="row">
      <button onclick="createProfile()">–°—ä–∑–¥–∞–π</button>
      <button class="secondary" onclick="hideCreate()">–û—Ç–∫–∞–∑</button>
    </div>
    <div class="small" style="margin-top:10px">–ê–∫–æ –æ—Å—Ç–∞–≤–∏—à PIN –ø—Ä–∞–∑–µ–Ω ‚Üí –≤—Ö–æ–¥ –±–µ–∑ PIN.</div>
  </div>

  <div class="card">
    <div class="small">–ò–º–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª (–æ—Ç —Å—Ç–∞—Ä —Ç–µ–ª–µ—Ñ–æ–Ω)</div>
    <button class="secondary" onclick="importProfile()">–ò–º–ø–æ—Ä—Ç JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none">
  </div>
</div>

<h1 id="title">CashControl</h1>
<div class="small" id="subtitle">–ü—Ä–æ—Ñ–∏–ª: ‚Äî</div>

<div class="tabs">
  <button class="tab active" id="tabDash" onclick="setTab('dash')">–¢–∞–±–ª–æ</button>
  <button class="tab" id="tabAdd" onclick="setTab('add')">–î–æ–±–∞–≤–∏</button>
  <button class="tab" id="tabSettings" onclick="setTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<div id="dash" class="card">
  <div class="small">–ë–∞–ª–∞–Ω—Å</div>
  <div style="font-size:22px;font-weight:900;margin-top:6px" id="balance">‚Ç¨0.00</div>
  <div class="chartBox" style="margin-top:10px"><canvas id="chart"></canvas></div>

  <div class="small" style="margin-top:10px">–ü–æ—Å–ª–µ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏</div>
  <div id="txList"></div>
</div>

<div id="add" class="card" style="display:none">
  <div class="small">–î–æ–±–∞–≤–∏ –∑–∞–ø–∏—Å</div>
  <select id="type">
    <option value="income">–î–æ—Ö–æ–¥</option>
    <option value="expense">–†–∞–∑—Ö–æ–¥</option>
  </select>
  <input id="amount" type="number" inputmode="decimal" placeholder="–°—É–º–∞ ‚Ç¨">
  <input id="note" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)">
  <button onclick="addTx()">–î–æ–±–∞–≤–∏</button>
</div>

<div id="settings" class="card" style="display:none">
  <div class="small">–ü—Ä–æ—Ñ–∏–ª</div>
  <button class="secondary" onclick="switchProfile()">–°–º–µ–Ω–∏ –ø—Ä–æ—Ñ–∏–ª</button>
  <button class="secondary" onclick="exportProfile()">Export (–ø—Ä–æ—Ñ–∏–ª)</button>
  <button class="secondary" onclick="importProfile()">Import (–ø—Ä–æ—Ñ–∏–ª)</button>
  <button class="danger" onclick="logout()">–ò–∑—Ö–æ–¥</button>

  <div class="small" style="margin-top:12px">‚ö†Ô∏è –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ</div>
  <button class="danger" onclick="resetProfileData()">–ò–∑—Ç—Ä–∏–π –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // =====================
  // CashControl: Profiles
  // =====================
  const PROFILES_KEY = "cashcontrol_profiles_v1";
  const ACTIVE_KEY   = "cashcontrol_active_v1";

  let profile = null;
  let state = null;
  let chart = null;

  function loadProfiles(){
    try { return JSON.parse(localStorage.getItem(PROFILES_KEY) || "[]"); }
    catch(e){ return []; }
  }
  function saveProfiles(list){
    localStorage.setItem(PROFILES_KEY, JSON.stringify(list));
  }

  // ‚úÖ EMPTY DEFAULTS
  function defaultState(){
    return { tx: [] };
  }

  function stateKey(id){ return "cashcontrol_state__" + id; }
  function saveState(){
    if(!profile) return;
    localStorage.setItem(stateKey(profile.id), JSON.stringify(state));
  }
  function loadState(id){
    const raw = localStorage.getItem(stateKey(id));
    return raw ? JSON.parse(raw) : defaultState();
  }

  function showOverlay(){
    document.getElementById("overlay").style.display="block";
    renderProfileList();
  }
  function hideOverlay(){
    document.getElementById("overlay").style.display="none";
    hideCreate();
  }

  function showCreate(){ document.getElementById("createCard").style.display="block"; }
  function hideCreate(){
    document.getElementById("createCard").style.display="none";
    document.getElementById("newName").value="";
    document.getElementById("newPin").value="";
  }

  function renderProfileList(){
    const box = document.getElementById("profileList");
    box.innerHTML = "";

    const profiles = loadProfiles();
    if(!profiles.length){
      box.innerHTML = `<div class="small">–ù—è–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏. –°—ä–∑–¥–∞–π –ø—ä—Ä–≤–∏—è –æ—Ç ‚Äû–ù–æ–≤ –ø—Ä–æ—Ñ–∏–ª‚Äú.</div>`;
      return;
    }

    profiles.forEach(p=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div style="font-weight:900">${p.name}</div>
          <div class="small">${p.pin ? "üîí PIN" : "–ë–µ–∑ PIN"}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;min-width:140px">
          <button class="secondary" style="margin-top:0" data-act="open">–í—Ö–æ–¥</button>
          <button class="danger" style="margin-top:0" data-act="del">–ò–∑—Ç—Ä–∏–π</button>
        </div>
      `;
      div.querySelector('[data-act="open"]').onclick = ()=> login(p);
      div.querySelector('[data-act="del"]').onclick  = ()=> deleteProfile(p);
      box.appendChild(div);
    });
  }

  function createProfile(){
    const name = document.getElementById("newName").value.trim();
    const pin  = document.getElementById("newPin").value.trim();
    if(!name) return alert("–í—ä–≤–µ–¥–∏ –∏–º–µ.");

    const profiles = loadProfiles();
    const p = { id: Date.now().toString(), name, pin: pin || "" };
    profiles.push(p);
    saveProfiles(profiles);

    localStorage.setItem(ACTIVE_KEY, p.id);
    profile = p;
    state = defaultState();
    saveState();

    hideOverlay();
    render();
  }

  function login(p){
    if(p.pin){
      const entered = prompt("PIN –∑–∞ " + p.name + ":");
      if(entered !== p.pin) return alert("–ì—Ä–µ—à–µ–Ω PIN.");
    }
    profile = p;
    state = loadState(p.id);
    localStorage.setItem(ACTIVE_KEY, p.id);
    hideOverlay();
    render();
  }

  function deleteProfile(p){
    if(!confirm(`–î–∞ –∏–∑—Ç—Ä–∏—è –ø—Ä–æ—Ñ–∏–ª "${p.name}"? –¢–æ–≤–∞ –∏–∑—Ç—Ä–∏–≤–∞ –∏ –¥–∞–Ω–Ω–∏—Ç–µ.`)) return;

    const profiles = loadProfiles().filter(x=>x.id !== p.id);
    saveProfiles(profiles);
    localStorage.removeItem(stateKey(p.id));

    if(profile && profile.id === p.id){
      profile = null;
      state = null;
      localStorage.removeItem(ACTIVE_KEY);
      showOverlay();
    } else {
      renderProfileList();
    }
  }

  function switchProfile(){ showOverlay(); }

  function logout(){
    profile = null;
    state = null;
    localStorage.removeItem(ACTIVE_KEY);
    if(chart){ chart.destroy(); chart = null; }
    document.getElementById("title").textContent = "CashControl";
    document.getElementById("subtitle").textContent = "–ü—Ä–æ—Ñ–∏–ª: ‚Äî";
    document.getElementById("balance").textContent = "‚Ç¨0.00";
    document.getElementById("txList").innerHTML = "";
    showOverlay();
  }

  function resetProfileData(){
    if(!profile) return;
    if(!confirm("–î–∞ –∏–∑—Ç—Ä–∏—è –≤—Å–∏—á–∫–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ç–æ–∑–∏ –ø—Ä–æ—Ñ–∏–ª?")) return;
    state = defaultState();
    saveState();
    render();
  }

  // =====================
  // CashControl: App
  // =====================
  function addTx(){
    if(!profile) return showOverlay();
    const type = document.getElementById("type").value;
    const amt  = Number(document.getElementById("amount").value);
    const note = (document.getElementById("note").value || "").trim();
    if(!Number.isFinite(amt) || amt <= 0) return alert("–í—ä–≤–µ–¥–∏ —Å—É–º–∞ > 0.");

    state.tx.push({ type, amt, note, ts: Date.now() });
    document.getElementById("amount").value = "";
    document.getElementById("note").value = "";
    saveState();
    render();
    setTab("dash");
  }

  function calcBalance(){
    let b = 0;
    for(const t of state.tx){
      if(t.type === "income") b += t.amt;
      else b -= t.amt;
    }
    return b;
  }

  function renderTx(){
    const box = document.getElementById("txList");
    box.innerHTML = "";
    const last = state.tx.slice().sort((a,b)=>b.ts-a.ts).slice(0,8);
    if(!last.length){
      box.innerHTML = `<div class="small" style="margin-top:8px">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏. –û—Ç–∏–¥–∏ –Ω–∞ ‚Äû–î–æ–±–∞–≤–∏‚Äú.</div>`;
      return;
    }
    last.forEach(t=>{
      const sign = t.type==="income" ? "+" : "‚àí";
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div>
          <div style="font-weight:900">${t.note ? t.note : (t.type==="income" ? "–î–æ—Ö–æ–¥" : "–†–∞–∑—Ö–æ–¥")}</div>
          <div class="small">${new Date(t.ts).toLocaleString("bg-BG")}</div>
        </div>
        <b>${sign} ‚Ç¨${t.amt.toFixed(2)}</b>
      `;
      box.appendChild(div);
    });
  }

  function renderChart(){
    const inc = state.tx.filter(t=>t.type==="income").reduce((s,t)=>s+t.amt,0);
    const exp = state.tx.filter(t=>t.type==="expense").reduce((s,t)=>s+t.amt,0);

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("chart"),{
      type:"doughnut",
      data:{
        labels:["–î–æ—Ö–æ–¥–∏","–†–∞–∑—Ö–æ–¥–∏"],
        datasets:[{ data:[inc, exp] }]
      },
      options:{ responsive:true, maintainAspectRatio:false, animation:false }
    });
  }

  function render(){
    if(!profile || !state) return;
    document.getElementById("title").textContent = "CashControl";
    document.getElementById("subtitle").textContent = "–ü—Ä–æ—Ñ–∏–ª: " + profile.name;

    const b = calcBalance();
    document.getElementById("balance").textContent = "‚Ç¨" + b.toFixed(2);

    renderTx();
    renderChart();
  }

  function setTab(tab){
    const tabs = ["dash","add","settings"];
    tabs.forEach(t=>{
      document.getElementById(t).style.display = (t===tab) ? "block" : "none";
      document.getElementById("tab"+t.charAt(0).toUpperCase()+t.slice(1)).classList.toggle("active", t===tab);
    });
  }

  // Export / Import
  function exportProfile(){
    if(!profile || !state) return;

    const payload = {
      app: "CashControl",
      version: 1,
      exportedAt: new Date().toISOString(),
      profile: { name: profile.name, pin: profile.pin || "" },
      state
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const safe = profile.name.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø_-]+/g,"_");
    a.download = `cashcontrol-${safe}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importProfile(){
    const input = document.getElementById("importFile");
    input.value = "";
    input.click();
    input.onchange = async ()=>{
      const file = input.files?.[0];
      if(!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);

        if(!parsed || parsed.app!=="CashControl" || !parsed.profile || !parsed.state || !Array.isArray(parsed.state.tx)){
          throw new Error("bad");
        }

        const profiles = loadProfiles();

        // new profile id (avoid overwrite)
        const newId = Date.now().toString() + "_" + Math.random().toString(16).slice(2);
        const p = { id:newId, name: parsed.profile.name || "–ò–º–ø–æ—Ä—Ç", pin: parsed.profile.pin || "" };

        profiles.push(p);
        saveProfiles(profiles);
        localStorage.setItem(stateKey(p.id), JSON.stringify(parsed.state));

        alert("–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ ‚úÖ");
        renderProfileList();
      }catch(e){
        alert("–ù–µ—É—Å–ø–µ—à–µ–Ω –∏–º–ø–æ—Ä—Ç. –£–≤–µ—Ä–∏ —Å–µ, —á–µ —Ñ–∞–π–ª—ä—Ç –µ export –æ—Ç CashControl.");
      }
    };
  }

  // Boot
  window.onload = ()=>{
    const activeId = localStorage.getItem(ACTIVE_KEY);
    const profiles = loadProfiles();

    if(activeId){
      const p = profiles.find(x=>x.id===activeId);
      if(p){
        // Require PIN each time if PIN exists
        if(p.pin){
          showOverlay();
        } else {
          profile = p;
          state = loadState(p.id);
          render();
          return;
        }
      }
    }
    showOverlay();
  };
</script>
</body>
</html>
